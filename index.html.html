<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-translate="pageTitle">نظام إدارة طلبات المكتبة</title>

  <!-- Fonts & icons (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#2c3e50; --primary-strong:#223043; --accent:#3498db; --success:#27ae60;
      --muted:#7f8c8d; --card:#ffffff; --shadow: 0 6px 18px rgba(0,0,0,.08); --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:'Cairo',Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa 0%,#e9f0f6 100%);margin:0;padding:24px;color:var(--primary);direction:rtl}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    header h1{font-size:20px;margin:0;display:flex;align-items:center;gap:10px}
    .lang-switch button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .admin-trigger{background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}

    /* layout */
    .grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}

    /* main card */
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);}

    /* tabs & products */
    .tabs{display:flex;gap:10px;margin-bottom:16px}
    .tab{padding:10px 14px;border-radius:10px;background:#f3f6f9;border:1px solid #e6eef7;cursor:pointer;font-weight:700}
    .tab.active{background:var(--primary);color:#fff;border-color:transparent}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .product{background:#fff;border-radius:10px;padding:12px;border:1px solid #eef3f7;display:flex;flex-direction:column;align-items:center;gap:8px;transition:transform .14s,box-shadow .14s}
    .product:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .product img{width:100%;height:130px;object-fit:contain;border-radius:8px;background:#fbfdff;padding:8px}
    .product .name{font-weight:700;text-align:center}
    .product .meta{color:var(--muted);font-size:13px}
    .product .price{font-weight:800;color:var(--primary);margin-top:6px}

    /* sidebar layout (right column) */
    .sidebar .section{margin-bottom:14px}
    .form-row{display:flex;gap:8px}
    .form-col{flex:1}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type="text"], input[type="tel"], select{width:100%;padding:10px;border:1px solid #e6edf3;border-radius:10px}
    .small{font-size:13px;color:var(--muted)}

    /* cart */
    .cart-table{width:100%;border-collapse:collapse;margin-top:8px}
    .cart-table th,.cart-table td{border-bottom:1px solid #eef3f7;padding:8px;text-align:right}
    .cart-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
    .totals{margin-top:12px;padding-top:12px;border-top:1px dashed #e6eef3;font-weight:800;text-align:right}

    /* buttons */
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:2px solid #eef3f7;color:var(--primary)}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999;align-items:center;justify-content:center;padding:20px}
    .modal .modal-card{width:100%;max-width:880px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.18);max-height:90vh;overflow:auto}
    .modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .modal .row{display:flex;gap:10px}
    .file-preview{max-width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #eef3f7}

    /* responsive tweaks */
    @media (max-width:600px){
      .product img{height:100px}
      .grid{gap:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-book"></i> <span data-translate="pageTitle">نظام إدارة طلبات المكتبة</span></h1>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="lang-switch"><button id="toggleLang" class="btn">English</button></div>
        <button id="openAdminBtn" class="admin-trigger">⚙️ الإدارة</button>
      </div>
    </header>

    <div class="grid">
      <!-- MAIN COLUMN -->
      <div>
        <div class="card">
          <div class="tabs" role="tablist">
            <div class="tab active" data-tab="books" id="tabBooks"><i class="fas fa-book"></i> <span data-translate="books">كتب</span></div>
            <div class="tab" data-tab="stationery" id="tabStationery"><i class="fas fa-pencil-alt"></i> <span data-translate="stationery">أدوات مكتبية</span></div>
          </div>

          <div id="products" class="products" aria-live="polite"></div>
        </div>
      </div>

      <!-- SIDEBAR -->
      <aside class="sidebar">
        <!-- Customer data card (moved before cart) -->
        <div class="card section">
          <h3><i class="fas fa-user"></i> <span data-translate="customerData">بيانات العميل</span></h3>
          <div style="margin-top:10px">
            <div class="form-group">
              <label for="custName" data-translate="custNameLbl">اسم ولي الأمر</label>
              <input id="custName" type="text" placeholder="أدخل الاسم الكامل">
            </div>
            <div class="form-group">
              <label for="custPhone" data-translate="custPhoneLbl">رقم الهاتف</label>
              <input id="custPhone" type="tel" placeholder="مثال: 20123456789">
            </div>
            <div class="form-group">
              <label for="custAddress" data-translate="custAddressLbl">العنوان</label>
              <input id="custAddress" type="text" placeholder="المدينة والمنطقة">
            </div>
            <div class="form-group">
              <label for="paymentMethod" data-translate="paymentMethodLbl">طريقة الدفع</label>
              <select id="paymentMethod">
                <option value="instapay">InstaPay</option>
                <option value="cod">الدفع عند الاستلام</option>
              </select>
            </div>
            <div id="instaGroup" class="form-group">
              <label for="instaHandle" data-translate="instaLbl">معرف InstaPay</label>
              <input id="instaHandle" type="text" placeholder="مثال: username@instapay">
            </div>
          </div>
        </div>

        <!-- Cart card -->
        <div class="card section">
          <h3><i class="fas fa-shopping-cart"></i> <span data-translate="cart">سلة المشتريات</span></h3>
          <div style="margin-top:10px;overflow:auto">
            <table class="cart-table" id="cartTable" aria-live="polite">
              <thead>
                <tr>
                  <th data-translate="item">المنتج</th>
                  <th data-translate="qty">الكمية</th>
                  <th data-translate="unitPrice">السعر</th>
                  <th data-translate="lineTotal">الإجمالي</th>
                  <th> </th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="totals" id="cartTotals">
              <div id="subtotalRow">المجموع: 0 ج.م</div>
              <div id="discountRow">الخصم: 0 ج.م</div>
              <div id="grandRow" style="margin-top:8px">الإجمالي النهائي: 0 ج.م</div>
            </div>

            <div class="cart-actions" style="margin-top:12px">
              <button id="btnInvoice" class="btn primary" title="عرض الفاتورة"><i class="fas fa-receipt"></i> <span data-translate="invoiceBtnTxt">عرض الفاتورة</span></button>
              <button id="btnExport" class="btn secondary" title="تصدير الطلب"><i class="fas fa-download"></i> <span data-translate="exportBtnTxt">تصدير الطلب</span></button>
            </div>
          </div>
        </div>

        <!-- Admin quick search -->
        <div class="card section">
          <h4><i class="fas fa-tools"></i> <span data-translate="adminToolsTitle">أدوات إدارية</span></h4>
          <div style="margin-top:8px">
            <label for="adminSearch" class="small" data-translate="adminSearchLbl">بحث إداري</label>
            <input id="adminSearch" type="text" placeholder="ابحث في جميع المنتجات...">
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal: Admin password prompt (simple) -->
  <div id="adminPasswordModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 data-translate="adminLogin">تسجيل دخول الإدارة</h3>
        <button id="closeAdminPassword" class="btn ghost">×</button>
      </div>
      <div style="text-align:right">
        <label for="adminPassword" class="form-label small">كلمة المرور</label>
        <input id="adminPassword" type="password" placeholder="ادخل كلمة المرور">
        <div style="margin-top:12px;text-align:center">
          <button id="adminPasswordEnter" class="btn primary">دخول</button>
          <button id="adminPasswordCancel" class="btn ghost">إلغاء</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PLACEHOLDER: Part 2 (script + admin panel modal + invoice modal) -->
  <!-- انسخ Part 2 هنا بعد نهاية Part 1 -->
  <!-- Admin Panel Modal (shows after correct password) -->
  <div id="adminPanelModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 data-translate="manageProducts">لوحة إدارة المنتجات</h3>
        <div>
          <button id="closeAdminPanel" class="btn ghost">إغلاق</button>
        </div>
      </div>

      <!-- Admin form: add/edit product -->
      <div style="text-align:right;display:grid;grid-template-columns:1fr;gap:8px">
        <div>
          <label class="small" data-translate="prodName">اسم المنتج</label>
          <input id="prodName" type="text" placeholder="">
        </div>
        <div>
          <label class="small" data-translate="prodType">النوع</label>
          <select id="prodType">
            <option value="book">كتاب</option>
            <option value="stationery">أدوات مكتبية</option>
          </select>
        </div>
        <div>
          <label class="small" data-translate="prodMeta">بيانات إضافية</label>
          <input id="prodMeta" type="text" placeholder="مثال: صف • مادة • سلسلة أو تصنيف">
        </div>
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <label class="small" data-translate="prodPrice">السعر (ج.م)</label>
            <input id="prodPrice" type="number" min="0" step="0.01">
          </div>
          <div style="flex:1">
            <label class="small" data-translate="prodImage">صورة المنتج</label>
            <input id="prodImage" type="file" accept="image/*">
            <div id="prodImagePreview" style="margin-top:8px"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
          <button id="saveProdBtn" class="btn primary" data-editing="">حفظ المنتج</button>
          <button id="clearProdFormBtn" class="btn ghost">مسح الحقول</button>
        </div>

        <hr style="margin:12px 0">

        <h4 data-translate="existingProducts">المنتجات الحالية</h4>
        <div id="adminProductsList" style="max-height:240px;overflow:auto"></div>

        <hr style="margin:12px 0">

        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start">
          <button id="refreshOrdersBtn" class="btn secondary">تحديث الطلبات</button>
          <button id="exportOrdersBtn" class="btn success">تصدير (Excel)</button>
          <button id="aggReportBtn" class="btn ghost">تقرير مجمّع</button>
          <button id="backupBtn" class="btn ghost">تنزيل نسخة احتياطية (JSON)</button>
          <button id="restoreBtn" class="btn ghost">رفع نسخة احتياطية</button>
          <input id="restoreFile" type="file" accept=".json" style="display:none">
        </div>

        <div style="margin-top:8px">
          <h4 data-translate="ordersTitle">الطلبات المسجلة</h4>
          <div id="ordersList" style="max-height:180px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <h3 data-translate="invoiceModalTitle">فاتورة الطلب</h3>
        <button id="closeInvoice" class="btn ghost">إغلاق</button>
      </div>
      <div id="invoiceBody" style="text-align:right"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button id="printInvoice" class="btn primary">طباعة</button>
        <button id="downloadPdf" class="btn secondary">حفظ PDF</button>
        <button id="sendWhats" class="btn success">إرسال واتساب</button>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  (function(){
    // Utils
    const $ = id => document.getElementById(id);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const fmt = (n, lang='ar') => lang==='en' ? n.toLocaleString('en-US')+' EGP' : n.toLocaleString('ar-EG')+' ج.م';
    const uid = (pref='id') => pref + Date.now().toString(36) + Math.floor(Math.random()*999).toString(36);

    // Translation strings
    const translations = {
      ar: {
        pageTitle: "نظام إدارة طلبات المكتبة",
        books: "كتب", stationery: "أدوات مكتبية",
        customerData: "بيانات العميل", custNameLbl: "اسم ولي الأمر", custPhoneLbl: "رقم الهاتف", custAddressLbl: "العنوان",
        paymentMethodLbl: "طريقة الدفع", instaLbl: "معرف InstaPay",
        cart: "سلة المشتريات", item: "الصنف", qty: "الكمية", unitPrice: "السعر", lineTotal: "الإجمالي",
        invoiceBtnTxt: "عرض الفاتورة", exportBtnTxt: "تصدير الطلب", adminToolsTitle: "أدوات إدارية", adminSearchLbl: "بحث إداري",
        adminLogin: "تسجيل دخول الإدارة", manageProducts: "إدارة المنتجات", prodName: "اسم المنتج", prodType: "النوع",
        prodMeta: "بيانات إضافية", prodPrice: "السعر (ج.م)", prodImage: "صورة المنتج", save: "حفظ", cancel: "إغلاق",
        existingProducts: "المنتجات الحالية", ordersTitle: "الطلبات المسجلة", refresh: "تحديث", exportOrders: "تصدير الطلبات",
        aggReport: "تقرير مجمّع", invoiceModalTitle: "فاتورة الطلب", downloadPdf: "تحميل PDF", close: "إغلاق"
      },
      en: {
        pageTitle: "Library Orders System",
        books: "Books", stationery: "Stationery",
        customerData: "Customer Data", custNameLbl: "Parent Name", custPhoneLbl: "Phone", custAddressLbl: "Address",
        paymentMethodLbl: "Payment Method", instaLbl: "InstaPay ID",
        cart: "Shopping Cart", item: "Item", qty: "Qty", unitPrice: "Unit Price", lineTotal: "Line Total",
        invoiceBtnTxt: "Show Invoice", exportBtnTxt: "Export Order", adminToolsTitle: "Admin Tools", adminSearchLbl: "Admin Search",
        adminLogin: "Admin Login", manageProducts: "Manage Products", prodName: "Product Name", prodType: "Type",
        prodMeta: "Extra data", prodPrice: "Price (EGP)", prodImage: "Product Image", save: "Save", cancel: "Close",
        existingProducts: "Existing Products", ordersTitle: "Saved Orders", refresh: "Refresh", exportOrders: "Export Orders",
        aggReport: "Aggregated Report", invoiceModalTitle: "Order Invoice", downloadPdf: "Download PDF", close: "Close"
      }
    };

    // State
    let lang = localStorage.getItem('lang') || 'ar';
    let activeTab = localStorage.getItem('tab') || 'books';
    let products = JSON.parse(localStorage.getItem('products')||'null');
    let cart = JSON.parse(localStorage.getItem('cart')||'[]');
    let orders = JSON.parse(localStorage.getItem('orders')||'[]');
    const ADMIN_PASSWORD_KEY = 'admin_password'; // optional stored pass (not secure against devtools)
    const DEFAULT_ADMIN_PASS = 'admin123';

    // default products if none
    const defaultProducts = [
      { id: 'b1', type:'book', name:'Gem English 3º', meta:'إعدادي • ثالث إعدادي • English • Gem', price:220, image:'https://via.placeholder.com/300x200?text=Gem+Eng+3' },
      { id: 'b2', type:'book', name:'المعاصر Math 2º', meta:'إعدادي • ثاني إعدادي • Math • المعاصر', price:200, image:'https://via.placeholder.com/300x200?text=Elmoasser+Math+2' },
      { id: 's1', type:'stationery', name:'كراس 60 ورقة', meta:'دفاتر', price:25, image:'https://via.placeholder.com/300x200?text=Notebook+60' },
      { id: 's2', type:'stationery', name:'قلم رصاص HB', meta:'أقلام', price:6, image:'https://via.placeholder.com/300x200?text=Pencil+HB' }
    ];
    if(!products){ products = defaultProducts; localStorage.setItem('products', JSON.stringify(products)); }

    // Apply translation to page static elements
    function applyLang(){
      localStorage.setItem('lang', lang);
      document.documentElement.lang = (lang==='en'?'en':'ar');
      document.documentElement.dir = (lang==='en'?'ltr':'rtl');

      qsa('[data-translate]').forEach(el=>{
        const key = el.getAttribute('data-translate');
        if(translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
      });

      // button text for toggle
      $('toggleLang').textContent = (lang==='en'? 'العربية' : 'English');

      // re-render dynamic parts
      renderProducts();
      renderCart();
      renderAdminProducts();
      renderOrdersList();
    }

    // Render products grid
    function renderProducts(){
      const wrap = $('products');
      wrap.innerHTML = '';
      const list = products.filter(p => activeTab === 'books' ? p.type==='book' : p.type==='stationery');
      if(list.length===0){
        wrap.innerHTML = `<div style="padding:20px;color:#666;text-align:center">${ lang==='en' ? 'No items' : 'لا توجد عناصر' }</div>`;
        return;
      }
      list.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'product';
        el.innerHTML = `
          <img src="${p.image||''}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
          <div class="name">${p.name}</div>
          <div class="meta">${p.meta||''}</div>
          <div class="price">${ fmt(p.price, lang) }</div>
          <div style="margin-top:8px"><button class="btn primary" data-add="${p.id}">${ lang==='en' ? 'Add' : 'أضف' }</button></div>
        `;
        wrap.appendChild(el);
      });
    }

    // Render cart
    function renderCart(){
      localStorage.setItem('cart', JSON.stringify(cart));
      const tbody = $('cartTable').querySelector('tbody');
      tbody.innerHTML = '';
      if(cart.length===0){
        tbody.innerHTML = `<tr><td colspan="5" style="color:#666;padding:12px;text-align:center">${ lang==='en' ? 'Cart is empty' : 'السلة فارغة' }</td></tr>`;
        $('cartTotals').querySelector('#subtotalRow').textContent = (lang==='en'?'Subtotal: ':'المجموع: ') + fmt(0,lang);
        $('cartTotals').querySelector('#discountRow').textContent = (lang==='en'?'Discount: ':'الخصم: ') + fmt(0,lang);
        $('cartTotals').querySelector('#grandRow').textContent = (lang==='en'?'Grand Total: ':'الإجمالي النهائي: ') + fmt(0,lang);
        return;
      }
      let subtotal = 0;
      cart.forEach((c, idx)=>{
        const line = c.price * c.qty;
        subtotal += line;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${c.name}</td>
          <td><input type="number" value="${c.qty}" min="1" data-idx="${idx}" style="width:64px;text-align:center;border-radius:6px;border:1px solid #e6edf3;padding:6px"></td>
          <td>${ fmt(c.price, lang) }</td>
          <td>${ fmt(line, lang) }</td>
          <td><button class="btn ghost" data-remove="${idx}"><i class="fas fa-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
      });
      const discount = subtotal >= 1500 ? Math.round(subtotal * 0.05) : 0;
      const grand = subtotal - discount;
      $('cartTotals').querySelector('#subtotalRow').textContent = (lang==='en'?'Subtotal: ':'المجموع: ') + fmt(subtotal,lang);
      $('cartTotals').querySelector('#discountRow').textContent = (lang==='en'?'Discount: ':'الخصم: ') + fmt(discount,lang);
      $('cartTotals').querySelector('#grandRow').textContent = (lang==='en'?'Grand Total: ':'الإجمالي النهائي: ') + fmt(grand,lang);
    }

    // Add to cart handler (delegation)
    document.body.addEventListener('click', async (e)=>{
      const add = e.target.closest('[data-add]');
      if(add){
        const id = add.getAttribute('data-add');
        const p = products.find(x=>x.id===id);
        if(!p) return;
        const i = cart.findIndex(it=>it.id===id);
        if(i>-1) cart[i].qty += 1;
        else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1, type: p.type });
        renderCart();
      }

      const rem = e.target.closest('[data-remove]');
      if(rem){
        const idx = +rem.getAttribute('data-remove');
        cart.splice(idx,1);
        renderCart();
      }

      // admin open password modal
      if(e.target.id === 'openAdminBtn') $('adminPasswordModal').style.display = 'flex';

      // admin password cancel/close
      if(e.target.id === 'closeAdminPassword' || e.target.id === 'adminPasswordCancel') $('adminPasswordModal').style.display = 'none';

      // admin password enter
      if(e.target.id === 'adminPasswordEnter'){
        const val = $('adminPassword').value || '';
        const stored = localStorage.getItem(ADMIN_PASSWORD_KEY) || DEFAULT_ADMIN_PASS;
        if(val === stored){
          $('adminPasswordModal').style.display = 'none';
          openAdminPanel();
        } else {
          alert(lang==='en' ? 'Wrong password' : 'كلمة مرور خاطئة');
        }
      }

      // admin panel close
      if(e.target.id === 'closeAdminPanel') $('adminPanelModal').style.display = 'none';

      // save product
      if(e.target.id === 'saveProdBtn'){
        saveProductFromAdmin();
      }

      // clear prod form
      if(e.target.id === 'clearProdFormBtn'){
        clearProdForm();
      }

      // admin product edit/delete (delegation on adminProductsList)
      const editBtn = e.target.closest('[data-edit-prod]');
      if(editBtn){
        const id = editBtn.getAttribute('data-edit-prod');
        const p = products.find(x=>x.id===id);
        if(!p) return;
        $('prodName').value = p.name;
        $('prodType').value = p.type;
        $('prodMeta').value = p.meta;
        $('prodPrice').value = p.price;
        if(p.image) {
          $('prodImagePreview').innerHTML = `<img src="${p.image}" class="file-preview">`;
        } else $('prodImagePreview').innerHTML = '';
        $('saveProdBtn').setAttribute('data-editing', p.id);
        // scroll admin modal to top
        $('adminPanelModal').scrollTop = 0;
      }
      const delBtn = e.target.closest('[data-del-prod]');
      if(delBtn){
        const id = delBtn.getAttribute('data-del-prod');
        if(!confirm(lang==='en' ? 'Delete product?' : 'هل تريد حذف المنتج؟')) return;
        products = products.filter(x=>x.id!==id);
        localStorage.setItem('products', JSON.stringify(products));
        renderAdminProducts();
        renderProducts();
      }

      // refresh orders
      if(e.target.id === 'refreshOrdersBtn') renderOrdersList();

      // export orders excel
      if(e.target.id === 'exportOrdersBtn') exportOrdersExcel();

      // aggregated report
      if(e.target.id === 'aggReportBtn') showAggregatedReport();

      // backup download
      if(e.target.id === 'backupBtn') downloadBackupJSON();

      // restore
      if(e.target.id === 'restoreBtn') $('restoreFile').click();

    });

    // qty change listener
    document.body.addEventListener('input',(e)=>{
      if(e.target.matches('input[data-idx]')){
        const idx = +e.target.getAttribute('data-idx');
        const v = Math.max(1, parseInt(e.target.value||1,10));
        cart[idx].qty = v;
        renderCart();
      }
    });

    // file input preview and store
    $('prodImage') && $('prodImage').addEventListener('change', async (e)=>{
      if(e.target.files && e.target.files[0]){
        const file = e.target.files[0];
        // preview
        const reader = new FileReader();
        reader.onload = function(ev){
          $('prodImagePreview').innerHTML = `<img src="${ev.target.result}" class="file-preview">`;
          $('prodImagePreview').setAttribute('data-base64', ev.target.result);
        };
        reader.readAsDataURL(file);
      }
    });

    // helper: file -> base64
    function fileToBase64(file){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = e => rej(e);
        r.readAsDataURL(file);
      });
    }

    // save product from admin form
    async function saveProductFromAdmin(){
      const name = $('prodName').value.trim();
      const type = $('prodType').value;
      const meta = $('prodMeta').value.trim();
      const price = parseFloat($('prodPrice').value) || 0;
      if(!name){ alert(lang==='en' ? 'Product name required' : 'اسم المنتج مطلوب'); return; }

      let imageData = '';
      // check preview data attribute first
      const preview = $('prodImagePreview').getAttribute('data-base64');
      if(preview) imageData = preview;
      else if($('prodImage').files && $('prodImage').files[0]){
        try{ imageData = await fileToBase64($('prodImage').files[0]); } catch(e){ console.error(e); }
      }

      const editing = $('saveProdBtn').getAttribute('data-editing');
      if(editing){
        products = products.map(p => p.id===editing ? {...p, name, type, meta, price, image: imageData || p.image} : p);
        $('saveProdBtn').removeAttribute('data-editing');
      } else {
        const id = uid(type==='book'?'b':'s');
        products.push({ id, type, name, meta, price, image: imageData || '' });
      }
      // persist and refresh
      localStorage.setItem('products', JSON.stringify(products));
      clearProdForm();
      renderAdminProducts();
      renderProducts();
      alert(lang==='en' ? 'Saved' : 'تم الحفظ');
    }

    function clearProdForm(){
      $('prodName').value=''; $('prodMeta').value=''; $('prodPrice').value=''; $('prodImage').value='';
      $('prodImagePreview').innerHTML=''; $('prodImagePreview').removeAttribute('data-base64');
      $('saveProdBtn').removeAttribute('data-editing');
    }

    // render admin products list
    function renderAdminProducts(){
      const wrap = $('adminProductsList');
      if(!wrap) return;
      wrap.innerHTML = '';
      products.forEach(p=>{
        const row = document.createElement('div');
        row.style = 'display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eef3f7';
        row.innerHTML = `
          <div style="flex:1;text-align:right">
            <div style="font-weight:700">${p.name}</div>
            <div style="font-size:13px;color:#666">${p.meta||''}</div>
            <div style="font-weight:800">${ fmt(p.price, lang) }</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn ghost" data-edit-prod="${p.id}">${ lang==='en' ? 'Edit' : 'تعديل' }</button>
            <button class="btn ghost" data-del-prod="${p.id}">${ lang==='en' ? 'Delete' : 'حذف' }</button>
          </div>
        `;
        wrap.appendChild(row);
      });
    }

    // Orders: checkout flow
    $('btnInvoice').addEventListener('click', ()=>{
      if(cart.length===0){ alert(lang==='en' ? 'Cart is empty' : 'السلة فارغة'); return; }
      // validate customer fields
      const cname = $('custName').value.trim();
      const cphone = $('custPhone').value.trim();
      if(!cname || !cphone){ alert(lang==='en' ? 'Fill customer name and phone' : 'من فضلك أدخل الاسم ورقم الهاتف'); return; }
      // open invoice modal
      showInvoice(buildInvoiceHTML());
    });

    function buildInvoiceHTML(orderObj){
      // use orderObj (if given) else use current cart + customer data
      const items = orderObj ? orderObj.items : cart.map(i=>({ name:i.name, qty:i.qty, price:i.price }));
      let html = `<div style="text-align:right;font-family:Arial, Tahoma; color:${varColor('#222')}"><h2 style="margin:0 0 8px">${translations[lang].pageTitle}</h2>`;
      html += `<div style="margin-bottom:8px"><b>${ lang==='en' ? 'Date' : 'التاريخ' }:</b> ${new Date().toLocaleString()}</div>`;
      if(!orderObj){
        html += `<div style="margin-bottom:8px"><b>${ lang==='en' ? 'Name' : 'الاسم' }:</b> ${$('custName').value||'-'}</div>`;
        html += `<div style="margin-bottom:8px"><b>${ lang==='en' ? 'Phone' : 'الهاتف' }:</b> ${$('custPhone').value||'-'}</div>`;
        html += `<div style="margin-bottom:8px"><b>${ lang==='en' ? 'Address' : 'العنوان' }:</b> ${$('custAddress').value||'-'}</div>`;
      } else {
        html += `<div style="margin-bottom:8px"><b>${ lang==='en' ? 'Order ID' : 'رقم الطلب' }:</b> ${orderObj.id}</div>`;
      }

      html += '<table style="width:100%;border-collapse:collapse;margin-top:6px"><thead><tr>';
      html += `<th style="border:1px solid #ccc;padding:6px;text-align:right">${ translations[lang].item }</th>`;
      html += `<th style="border:1px solid #ccc;padding:6px;text-align:center">${ translations[lang].qty }</th>`;
      html += `<th style="border:1px solid #ccc;padding:6px;text-align:center">${ translations[lang].unitPrice }</th>`;
      html += `<th style="border:1px solid #ccc;padding:6px;text-align:center">${ translations[lang].lineTotal }</th>`;
      html += `</tr></thead><tbody>`;
      let total = 0;
      items.forEach(it=>{
        const line = it.qty * it.price;
        total += line;
        html += `<tr><td style="padding:6px;border:1px solid #ccc;text-align:right">${it.name}</td><td style="padding:6px;border:1px solid #ccc;text-align:center">${it.qty}</td><td style="padding:6px;border:1px solid #ccc;text-align:center">${fmt(it.price,lang)}</td><td style="padding:6px;border:1px solid #ccc;text-align:center">${fmt(line,lang)}</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<div style="text-align:right;margin-top:10px;font-weight:800">${ lang==='en' ? 'Grand Total:' : 'الإجمالي النهائي:' } ${ fmt(total,lang) }</div>`;
      html += '</div>';
      return html;
    }

    // helper fn to set color in invoice (avoid inline var error)
    function varColor(c){ return c; }

    function showInvoice(html){
      $('invoiceBody').innerHTML = html;
      $('invoiceModal').style.display = 'flex';
    }

    $('closeInvoice').addEventListener('click', ()=> $('invoiceModal').style.display = 'none');

    $('printInvoice').addEventListener('click', ()=>{
      const w = window.open('','_blank');
      w.document.write(`<html><head><title>Invoice</title></head><body>${$('invoiceBody').innerHTML}</body></html>`);
      w.document.close(); w.print();
    });

    $('downloadPdf').addEventListener('click', async ()=>{
      const el = $('invoiceBody');
      const canvas = await html2canvas(el, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','mm','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(imgData);
      const pdfHeight = (imgProps.height * pageWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, pdfHeight);
      pdf.save('invoice.pdf');
    });

    $('sendWhats').addEventListener('click', ()=>{
      const phone = ($('custPhone').value||'').replace(/\D/g,'');
      const text = encodeURIComponent(
        (lang==='en' ? 'Order Invoice' : 'فاتورة الطلب') + '\n' +
        cart.map(c=>`${c.name} x${c.qty} = ${c.price*c.qty}`).join('\n') + '\n' +
        (lang==='en' ? 'Grand Total: ' : 'الإجمالي: ') + $('cartTotals').querySelector('#grandRow').textContent
      );
      const url = phone ? `https://wa.me/${phone}?text=${text}` : `https://wa.me/?text=${text}`;
      window.open(url,'_blank');
    });

    // Checkout saving order
    function saveCurrentOrder(){
      if(cart.length===0) return null;
      const order = {
        id: 'o'+Date.now(),
        createdAt: new Date().toISOString(),
        customer: { name: $('custName').value||'', phone: $('custPhone').value||'', address: $('custAddress').value||'' },
        items: cart.map(i=>({ id:i.id, name:i.name, price:i.price, qty:i.qty })),
        totals: { subtotal: cart.reduce((s,c)=>s+c.price*c.qty,0) }
      };
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));
      // clear cart
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      renderOrdersList();
      return order;
    }

    // On invoice confirm (user might want to save order to orders)
    // We can save when user prints / downloads or press a "save" button - here we'll save on Export action
    $('btnExport').addEventListener('click', async ()=>{
      // first show invoice modal
      if(cart.length===0){ alert(lang==='en' ? 'Cart is empty' : 'السلة فارغة'); return; }
      const html = buildInvoiceHTML();
      showInvoice(html);
      // also save order in storage
      const saved = saveCurrentOrder();
      if(saved) alert(lang==='en' ? 'Order saved' : 'تم حفظ الطلب');
    });

    // Orders list render in admin panel
    function renderOrdersList(){
      orders = JSON.parse(localStorage.getItem('orders')||'[]');
      const wrap = $('ordersList');
      if(!wrap) return;
      wrap.innerHTML = '';
      if(orders.length===0){ wrap.innerHTML = `<div style="color:#666">${ lang==='en' ? 'No orders yet' : 'لا توجد طلبات' }</div>`; return; }
      orders.slice().reverse().forEach(o=>{
        const d = document.createElement('div');
        d.style = 'padding:8px;border-bottom:1px solid #eef3f7;text-align:right';
        d.innerHTML = `<div style="font-weight:700">${ lang==='en' ? 'Order' : 'طلب' } ${o.id}</div>
          <div style="font-size:13px;color:#666">${ new Date(o.createdAt).toLocaleString() }</div>
          <div style="margin-top:6px">${ o.items.map(it=>`${it.name} x${it.qty}`).join(', ') }</div>`;
        wrap.appendChild(d);
      });
    }

    // Aggregated report
    function showAggregatedReport(){
      orders = JSON.parse(localStorage.getItem('orders')||'[]');
      if(!orders.length){ alert(lang==='en' ? 'No orders to aggregate' : 'لا توجد طلبات للتجميع'); return; }
      const agg = {};
      orders.forEach(o=>{
        o.items.forEach(it=>{
          if(!agg[it.id]) agg[it.id] = { name: it.name, qty: 0, price: it.price, times: 0 };
          agg[it.id].qty += it.qty;
          agg[it.id].times++;
        });
      });
      let html = `<h3 style="text-align:right">${ lang==='en' ? 'Aggregated Purchase Report' : 'تقرير مجمّع لطلبات المورد' }</h3>`;
      html += `<table style="width:100%;border-collapse:collapse;text-align:right"><thead><tr><th>${ translations[lang].item }</th><th>${ translations[lang].qty }</th><th>${ translations[lang].unitPrice }</th><th>${ translations[lang].lineTotal }</th><th>${ lang==='en' ? 'Times' : 'عدد الطلبات' }</th></tr></thead><tbody>`;
      let overall = 0;
      Object.values(agg).forEach(a=>{
        const line = a.qty * a.price;
        overall += line;
        html += `<tr><td style="padding:6px;border:1px solid #ccc">${a.name}</td><td style="padding:6px;border:1px solid #ccc">${a.qty}</td><td style="padding:6px;border:1px solid #ccc">${fmt(a.price,lang)}</td><td style="padding:6px;border:1px solid #ccc">${fmt(line,lang)}</td><td style="padding:6px;border:1px solid #ccc">${a.times}</td></tr>`;
      });
      html += `</tbody></table><div style="text-align:right;margin-top:10px;font-weight:800">${ lang==='en' ? 'Overall Total: ' : 'الإجمالي الكلي: ' } ${ fmt(overall,lang) }</div>`;
      const w = window.open('','_blank');
      w.document.write(`<html><head><title>Aggregated Report</title></head><body>${html}</body></html>`);
      w.document.close();
      w.print();
    }

    // Export orders to Excel (SheetJS)
    function exportOrdersExcel(){
      orders = JSON.parse(localStorage.getItem('orders')||'[]');
      if(!orders.length){ alert(lang==='en' ? 'No orders' : 'لا توجد طلبات'); return; }
      const rows = [[ 'Order ID', 'Date', 'Customer', 'Product', 'Qty', 'Unit Price', 'Line Total' ]];
      orders.forEach(o=>{
        o.items.forEach(it=>{
          rows.push([ o.id, new Date(o.createdAt).toLocaleString(), (o.customer && o.customer.name) || '', it.name, it.qty, it.price, it.qty*it.price ]);
        });
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Orders');
      XLSX.writeFile(wb, 'orders.xlsx');
    }

    // Backup / restore JSON
    function downloadBackupJSON(){
      const data = { products, orders };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'backup_products_orders.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    $('restoreFile') && $('restoreFile').addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (ev) => {
        try{
          const obj = JSON.parse(ev.target.result);
          if(obj.products) products = obj.products;
          if(obj.orders) orders = obj.orders;
          localStorage.setItem('products', JSON.stringify(products));
          localStorage.setItem('orders', JSON.stringify(orders));
          renderProducts(); renderAdminProducts(); renderOrdersList();
          alert(lang==='en' ? 'Restored' : 'تم الاستعادة');
        } catch(err){ alert('Invalid JSON'); }
      };
      r.readAsText(f);
    });

    // Export orders excel wrapper bound to button (if exists)
    function exportOrdersExcelWrapper(){ exportOrdersExcel(); }

    // Open admin panel after password OK
    function openAdminPanel(){
      $('adminPanelModal').style.display = 'flex';
      renderAdminProducts();
      renderOrdersList();
    }

    // Save current order as order object (used on export earlier)
    // Already implemented in saveCurrentOrder inside export flow

    // Event: language toggle
    $('toggleLang').addEventListener('click', ()=>{ lang = (lang==='ar'?'en':'ar'); applyLang(); });

    // Tabs
    qsa('.tab').forEach(t=> t.addEventListener('click', ()=>{
      qsa('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      activeTab = t.getAttribute('data-tab');
      localStorage.setItem('tab', activeTab);
      renderProducts();
    }));

    // Close modals when clicking outside
    window.addEventListener('click', (e)=>{
      if(e.target === $('adminPanelModal')) $('adminPanelModal').style.display = 'none';
      if(e.target === $('invoiceModal')) $('invoiceModal').style.display = 'none';
    });

    // init
    applyLang();
    renderProducts();
    renderCart();
    renderAdminProducts();
    renderOrdersList();

    // small UX: admin open shortcut
    $('openAdminBtn').addEventListener('click', ()=> $('adminPasswordModal').style.display = 'flex');

    // Utility: expose render functions for debug (optional)
    window._lib_render = { renderProducts, renderCart, renderAdminProducts, renderOrdersList };

  })();
  </script>

</body>
</html>
