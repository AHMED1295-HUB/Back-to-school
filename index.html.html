<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام XY لإدارة الطلبات</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;margin:0;background:#f6f8fb;color:#222;direction:rtl}
    header{background:#2c3e50;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:18px}
    .btn{padding:6px 12px;border-radius:6px;cursor:pointer;border:0;font-weight:bold}
    .btn-primary{background:#3498db;color:#fff}
    .btn-accent{background:#27ae60;color:#fff}
    .btn-outline{background:#fff;border:1px solid #ccc}
    .btn-danger{background:#e74c3c;color:#fff}
    .container{display:grid;grid-template-columns:1fr 340px;gap:14px;padding:14px}
    .panel{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .filter-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin:8px 0}
    .filter-input,.filter-select{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px}
    .tabs{display:flex;gap:6px;margin:8px 0}
    .tab{flex:1;padding:8px;border:0;cursor:pointer;border-radius:6px}
    .tab.active{background:#2c3e50;color:#fff}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:8px}
    .product-card{border:1px solid #eee;border-radius:6px;padding:8px;display:flex;flex-direction:column}
    .product-image{height:100px;object-fit:cover;border-radius:6px}
    .product-footer{margin-top:auto;display:flex;justify-content:space-between;align-items:center}
    .sidebar .summary-item{display:flex;justify-content:space-between;margin:4px 0}
    .cart-items{max-height:220px;overflow:auto;margin:8px 0}
    .cart-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.show{display:flex}
    .modal-content{background:#fff;padding:16px;border-radius:8px;max-width:900px;width:100%;max-height:90vh;overflow:auto;position:relative}
    .close{position:absolute;top:8px;left:8px;cursor:pointer;background:none;border:none;font-size:20px;color:red}
    .settings-tabs{display:flex;gap:6px;margin-bottom:10px}
    .settings-tab{flex:1;padding:8px;border:0;cursor:pointer;border-radius:6px}
    .settings-tab.active{background:#2c3e50;color:#fff}
    .settings-panel{display:none}
    .settings-panel.active{display:block}
    .xy-thumb{width:60px;height:40px;object-fit:cover;border-radius:6px;margin-top:4px}
    .small-field{display:flex;gap:6px;align-items:center;margin-top:6px}
/* أنماط CSS المعدلة للون الأسود والذهبي */
    :root {
      --gold: #D4AF37;
      --dark-gold: #B8860B;
      --black: #000000;
      --dark-gray: #1a1a1a;
      --light-gray: #333333;
      --text-light: #cccccc;
      --white: #ffffff;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: var(--black);
      color: var(--text-light);
      direction: rtl;
    }
    
    header {
      background: linear-gradient(to right, var(--black), var(--dark-gray));
      color: var(--gold);
      padding: 12px 16px;
      border-bottom: 2px solid var(--gold);
      text-align: center;
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      border: 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-primary:hover {
      background: var(--dark-gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);
    }
    
    .btn-accent {
      background: var(--dark-gray);
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    
    .btn-accent:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
    }
    
    .btn-outline:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-danger {
      background: #8B0000;
      color: var(--white);
    }
    
    .btn-danger:hover {
      background: #A52A2A;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      padding: 14px;
    }
    
    .panel {
      background: var(--dark-gray);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--light-gray);
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    
    .filter-input, .filter-select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .tabs {
      display: flex;
      gap: 6px;
      margin: 8px 0;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .product-card {
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      background: var(--black);
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
    }
    
    .product-image {
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--dark-gray);
    }
    
    .product-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--light-gray);
    }
    
    .sidebar .summary-item {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      padding: 4px 0;
      border-bottom: 1px dashed var(--light-gray);
    }
    
    .cart-items {
      max-height: 220px;
      overflow: auto;
      margin: 10px 0;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--dark-gray);
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      border: 2px solid var(--gold);
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }
    
    .close {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--gold);
    }
    
    .settings-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 15px;
    }
    
    .settings-tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .settings-tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .settings-panel {
      display: none;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .xy-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 4px;
      border: 1px solid var(--light-gray);
    }
    
    h2, h3, h4 {
      color: var(--gold);
      margin: 12px 0;
    }
    
    label {
      color: var(--text-light);
      margin-bottom: 5px;
      display: block;
    }
    
    /* الأسعار باللون الذهبي */
    #subtotalBooks, #subtotalStationery, #subtotalAll,
    #totalDiscount, #depositAmount, #grandTotal, #remainAmount,
    .product-footer div:first-child {
      color: var(--gold);
      font-weight: bold;
    }
    
    /* تحسينات للعناوين */
    .panel-header {
      border-bottom: 1px solid var(--gold);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    /* تحسينات الموبايل */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="mainTitle"><i class="fas fa-book"></i> نظام XY</h1>
    <div>
      <button id="langToggle" class="btn btn-outline">English</button>
      <button id="btnSettings" class="btn btn-primary"><i class="fas fa-cog"></i> إعدادات</button>
    </div>
  </header>

  <div class="container">
    <!-- المنتجات -->
    <div class="panel">
      <h3 id="filterTitle">خيارات البحث والتصفية</h3>
      <input id="searchInput" class="filter-input" placeholder="ابحث باسم المنتج...">
      <div class="filter-row">
        <div class="filter-group book-only">
          <label id="stageLbl">المرحلة</label>
          <select id="stageSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="gradeLbl">الصف</label>
          <select id="gradeSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="subjectLbl">المادة</label>
          <select id="subjectSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="seriesLbl">السلسلة</label>
          <select id="seriesSelect" class="filter-select"></select>
        </div>
      </div>
      <div class="tabs">
        <button id="tabBooks" class="tab active">كتب خارجية</button>
        <button id="tabStationery" class="tab">أدوات مكتبية</button>
      </div>
      <div id="booksGrid" class="products-grid"></div>
      <div id="stationeryGrid" class="products-grid" style="display:none"></div>
    </div>

    <!-- السلة -->
    <aside class="sidebar panel">
     <h3 id="cartTitle"></h3>
  <div class="panel" style="margin-bottom:10px">
    <label for="custName"></label>
    <input id="custName" class="filter-input">

    <label for="custPhone"></label>
    <input id="custPhone" class="filter-input">

    <label for="custAddress"></label>
    <input id="custAddress" class="filter-input">

    <label for="paymentMethod"></label>
    <select id="paymentMethod" class="filter-input">
      <option value="instapay"></option>
      <option value="cod"></option>
    </select>
  </div>
      <div id="cartItems" class="cart-items"></div>
      <div class="summary">
        <div class="summary-item"><span id="lblSubtotalBooks">إجمالي الكتب:</span><span id="subtotalBooks">0 ج.م</span></div>
        <div class="summary-item"><span id="lblSubtotalStationery">إجمالي الأدوات:</span><span id="subtotalStationery">0 ج.م</span></div>
        <div class="summary-item"><span id="lblSubtotalAll">المجموع قبل الخصم:</span><span id="subtotalAll">0 ج.م</span></div>
        <div class="summary-item"><span id="lblTotalDiscount">قيمة الخصم:</span><span id="totalDiscount">0 ج.م</span></div>
        <div class="summary-item"><span id="lblDepositAmount">المقدم:</span><span id="depositAmount">0 ج.م</span></div>
        <div class="summary-item"><span id="lblGrandTotal">الإجمالي النهائي:</span><span id="grandTotal">0 ج.م</span></div>
        <div class="summary-item"><span id="lblRemainAmount">المتبقي عند الاستلام:</span><span id="remainAmount">0 ج.م</span></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="btnInvoice" class="btn btn-primary" style="flex:1">فاتورة</button>
        <button id="btnClear" class="btn btn-danger" style="flex:1">تفريغ</button>
      </div>
    </aside>
  </div>

  <!-- نافذة تسجيل الدخول -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="loginModal.classList.remove('show')">&times;</button>
      <h3 id="loginTitle">تسجيل الدخول</h3>
      <input id="adminEmail" placeholder="Email" class="filter-input">
      <input id="adminPassword" type="password" placeholder="Password" class="filter-input">
      <button id="loginSubmit" class="btn btn-primary">دخول</button>
    </div>
  </div>

  <!-- نافذة الإعدادات -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="settingsModal.classList.remove('show')">&times;</button>
      <h3 id="settingsTitle">إعدادات الإدارة</h3>
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="productsPanel">المنتجات</button>
        <button class="settings-tab" data-tab="discountPanel">الخصم</button>
        <button class="settings-tab" data-tab="filtersPanel">الفلاتر</button>
      </div>

      <!-- المنتجات -->
      <div id="productsPanel" class="settings-panel active">
        <h4>قائمة المنتجات</h4>
        <div id="productsList"></div>
        <h4>إضافة / تعديل منتج</h4>
        <input id="newProdName" placeholder="اسم المنتج" class="filter-input">
        <select id="newProdType" class="filter-input">
          <option value="book">كتاب</option>
          <option value="stationery">أداة مكتبية</option>
        </select>
        <input id="newProdPrice" type="number" placeholder="السعر" class="filter-input">
        <input id="newProdSeries" placeholder="السلسلة/الفئة" class="filter-input">
        <input id="newProdImage" type="file" accept="image/*" class="filter-input">
        <img id="newProdPreview" class="xy-thumb" style="display:none">
        <div style="margin-top:6px;display:flex;gap:6px">
          <button id="addProductBtn" class="btn btn-primary" style="flex:1">إضافة</button>
          <button id="updateProductBtn" class="btn btn-accent" style="flex:1">تحديث</button>
        </div>
      </div>

      <!-- الخصم -->
      <div id="discountPanel" class="settings-panel">
        <h4>إعداد الخصم</h4>
        <label>نسبة الخصم %</label>
        <input id="discountRate" type="number" class="filter-input">
        <label>نسبة المقدم %</label>
        <input id="depositRate" type="number" class="filter-input">
        <button id="saveDiscountBtn" class="btn btn-primary" style="margin-top:6px">حفظ</button>
      </div>

      <!-- الفلاتر -->
      <div id="filtersPanel" class="settings-panel">
        <h4>إدارة الفلاتر</h4>

        <div style="margin-top:8px">
          <label>المراحل</label>
          <div id="filtersStages"></div>
          <div class="small-field">
            <input id="newStage" class="filter-input" placeholder="أدخل مرحلة جديدة">
            <button id="addStageBtn" class="btn btn-primary">إضافة مرحلة</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>الصفوف</label>
          <div id="filtersGrades"></div>
          <div class="small-field">
            <input id="newGrade" class="filter-input" placeholder="أدخل صف جديد">
            <button id="addGradeBtn" class="btn btn-primary">إضافة صف</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>المواد</label>
          <div id="filtersSubjects"></div>
          <div class="small-field">
            <input id="newSubject" class="filter-input" placeholder="أدخل مادة جديدة">
            <button id="addSubjectBtn" class="btn btn-primary">إضافة مادة</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>السلاسل</label>
          <div id="filtersSeries"></div>
          <div class="small-field">
            <input id="newSeries" class="filter-input" placeholder="أدخل سلسلة جديدة">
            <button id="addSeriesBtn" class="btn btn-primary">إضافة سلسلة</button>
          </div>
        </div>

      </div>
    </div>
  </div>
  <!-- نافذة الفاتورة -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="invoiceModal.classList.remove('show')">&times;</button>
      <h3 id="invoiceTitle">فاتورة الطلب</h3>
      <div id="invoiceBody"></div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="printInvoiceBtn" class="btn btn-primary">طباعة</button>
        <button id="downloadPdfBtn" class="btn btn-primary"></button>
            </div>
    </div>
  </div>

<script>
/* =========================
   XY System - JavaScript (Complete with Filters Management)
   ========================= */

const ADMIN = { email: "admin@example.com", password: "1234" };
let currentLang = "ar"; // "ar" or "en"

/* ---------- DATA (load from localStorage or default sample) ---------- */
let products = JSON.parse(localStorage.getItem("xy_products_v2")) || [
  { id: 101, type: "book", name: "الرياضيات - الصف الأول", price: 50, stage: "الابتدائية", grade: "الصف الأول", subject: "الرياضيات", series: "سلسلة النجاح", image: "" },
  { id: 102, type: "book", name: "اللغة العربية - الصف الأول", price: 45, stage: "الابتدائية", grade: "الصف الأول", subject: "اللغة العربية", series: "سلسلة النجاح", image: "" },
  { id: 103, type: "book", name: "العلوم - الصف الثاني", price: 55, stage: "الابتدائية", grade: "الصف الثاني", subject: "العلوم", series: "سلسلة التميز", image: "" },
  { id: 104, type: "book", name: "الإنجليزية - الصف الثالث", price: 60, stage: "الابتدائية", grade: "الصف الثالث", subject: "الإنجليزية", series: "سلسلة التميز", image: "" },
  { id: 105, type: "book", name: "الرياضيات - الصف الرابع", price: 70, stage: "الابتدائية", grade: "الصف الرابع", subject: "الرياضيات", series: "سلسلة التفوق", image: "" },
  { id: 201, type: "stationery", name: "دفتر سادة A4", price: 15, category: "قرطاسية", image: "" },
  { id: 202, type: "stationery", name: "قلم رصاص HB", price: 5, category: "قرطاسية", image: "" },
  { id: 203, type: "stationery", name: "مسطرة 30 سم", price: 8, category: "قرطاسية", image: "" },
  { id: 204, type: "stationery", name: "ممحاة", price: 3, category: "قرطاسية", image: "" },
  { id: 205, type: "stationery", name: "علبة ألوان", price: 40, category: "قرطاسية", image: "" }
];

let filters = JSON.parse(localStorage.getItem("xy_filters_v2")) || {
  stages: ["الابتدائية", "الإعدادية", "الثانوية"],
  grades: ["الصف الأول", "الصف الثاني", "الصف الثالث", "الصف الرابع", "الصف الخامس"],
  subjects: ["اللغة العربية", "الرياضيات", "العلوم", "الإنجليزية"],
  series: ["سلسلة النجاح", "سلسلة التميز", "سلسلة التفوق"]
};

let discountSettings = JSON.parse(localStorage.getItem("xy_discount_v2")) || { discountRate: 0, depositRate: 40 };
let cart = []; // {id, qty, ...product}

/* ---------- TRANSLATIONS ---------- */
const T = {
  ar: {
    pageTitle: "نظام XY لإدارة الطلبات",
    mainTitle: "نظام XY",
    langText: "English",
    filterTitle: "خيارات البحث والتصفية",
    searchPlaceholder: "ابحث باسم المنتج...",
    stageLbl: "المرحلة",
    gradeLbl: "الصف",
    subjectLbl: "المادة",
    seriesLbl: "السلسلة",
    booksTab: "كتب خارجية",
    stationeryTab: "أدوات مكتبية",
    cartTitle: "سلة المشتريات",
    parentName: "اسم ولي الأمر",
    enterName: "أدخل الاسم الكامل",
    phone: "رقم الهاتف",
    phoneEx: "مثال: 20123456789",
    address: "العنوان",
    addressEx: "المدينة / المنطقة",
    payment: "طريقة الدفع",
    paymentInstapay: "انستاباي",
    paymentCOD: "عند الاستلام",
    subtotalBooks: "إجمالي الكتب:",
    subtotalStationery: "إجمالي الأدوات:",
    subtotalAll: "المجموع قبل الخصم:",
    totalDiscount: "قيمة الخصم:",
    depositAmount: "المقدم:",
    grandTotal: "الإجمالي النهائي:",
    remainAmount: "المتبقي عند الاستلام:",
    invoice: "فاتورة",
    export: "تصدير CSV",
    clearCart: "تفريغ",
    loginTitle: "تسجيل الدخول",
    settingsTitle: "إعدادات الإدارة",
    productsTab: "المنتجات",
    discountTab: "الخصم",
    addProd: "إضافة",
    updateProd: "تحديث",
    refreshProd: "تحديث العرض",
    saveDiscount: "حفظ",
    loginWrong: "بيانات الدخول غير صحيحة",
    productAdded: "تم إضافة المنتج",
    productUpdated: "تم تحديث المنتج",
    productRemoved: "تم حذف المنتج",
    filtersSaved: "تم حفظ الفلاتر",
    csvSaved: "تم تنزيل CSV",
    invoiceTitle: "فاتورة الطلب",
    print: "طباعة",
pdf: "تحميل pdf",
    whatsapp: "إرسال واتساب",
    cartEmpty: "السلة فارغة",
    confirmClearCart: "هل تريد تفريغ السلة؟",
    increase: "+",
    decrease: "-",
    deleted: "تم الحذف",
    enterPhone: "أدخل رقم الموبايل",
    enterProdName: "ادخل اسم المنتج",
    noEdit: "لا توجد عملية تعديل",
  },
  en: {
    pageTitle: "XY Order System",
    mainTitle: "XY System",
    langText: "العربية",
    filterTitle: "Search & Filters",
    searchPlaceholder: "Search product name...",
    stageLbl: "Stage",
    gradeLbl: "Grade",
    subjectLbl: "Subject",
    seriesLbl: "Series",
    booksTab: "Books",
    stationeryTab: "Stationery",
    cartTitle: "Shopping Cart",
    parentName: "Parent Name",
    enterName: "Enter full name",
    phone: "Phone",
    phoneEx: "Example: 20123456789",
    address: "Address",
    addressEx: "City / Area",
      payment: "Payment Method",
      paymentInstapay: "Instapay",
  paymentCOD: "Cash on Delivery",
    subtotalBooks: "Books Total:",
    subtotalStationery: "Stationery Total:",
    subtotalAll: "Subtotal:",
    totalDiscount: "Discount:",
    depositAmount: "Deposit:",
    grandTotal: "Final Total:",
    remainAmount: "Remaining:",
    invoice: "Invoice",
    export: "Export CSV",
    clearCart: "Clear",
    loginTitle: "Login",
    settingsTitle: "Admin Settings",
    productsTab: "Products",
    discountTab: "Discount",
    addProd: "Add",
    updateProd: "Update",
    refreshProd: "Refresh",
    saveDiscount: "Save",
    loginWrong: "Credentials incorrect",
    productAdded: "Product added",
    productUpdated: "Product updated",
    productRemoved: "Product removed",
    filtersSaved: "Filters saved",
    csvSaved: "CSV downloaded",
    invoiceTitle: "Order Invoice",
    print: "Print",
pdf: "download pdf",
    whatsapp: "Send WhatsApp",
    cartEmpty: "Cart is empty",
    confirmClearCart: "Clear cart?",
    increase: "+",
    decrease: "-",
    deleted: "Deleted",
    enterPhone: "Enter phone number",
    enterProdName: "Enter product name",
    noEdit: "No product selected",
  }
};

/* ---------- DOM refs ---------- */
const refs = {
  langToggle: document.getElementById("langToggle"),
  mainTitle: document.getElementById("mainTitle"),
  filterTitle: document.getElementById("filterTitle"),
  searchInput: document.getElementById("searchInput"),
  stageSelect: document.getElementById("stageSelect"),
  gradeSelect: document.getElementById("gradeSelect"),
  subjectSelect: document.getElementById("subjectSelect"),
  seriesSelect: document.getElementById("seriesSelect"),
  tabBooks: document.getElementById("tabBooks"),
  tabStationery: document.getElementById("tabStationery"),
  booksGrid: document.getElementById("booksGrid"),
  stationeryGrid: document.getElementById("stationeryGrid"),

  cartTitle: document.getElementById("cartTitle"),
  custName: document.getElementById("custName"),
  custPhone: document.getElementById("custPhone"),
  custAddress: document.getElementById("custAddress"),
  cartItems: document.getElementById("cartItems"),
  subtotalBooks: document.getElementById("subtotalBooks"),
  subtotalStationery: document.getElementById("subtotalStationery"),
  subtotalAll: document.getElementById("subtotalAll"),
  totalDiscount: document.getElementById("totalDiscount"),
  depositAmount: document.getElementById("depositAmount"),
  grandTotal: document.getElementById("grandTotal"),
  remainAmount: document.getElementById("remainAmount"),

  btnInvoice: document.getElementById("btnInvoice"),
  btnClear: document.getElementById("btnClear"),

  loginModal: document.getElementById("loginModal"),
  loginSubmit: document.getElementById("loginSubmit"),
  adminEmail: document.getElementById("adminEmail"),
  adminPassword: document.getElementById("adminPassword"),

  settingsModal: document.getElementById("settingsModal"),
  settingsTabs: document.querySelectorAll(".settings-tab"),
  settingsPanels: document.querySelectorAll(".settings-panel"),
  productsList: document.getElementById("productsList"),
  newProdName: document.getElementById("newProdName"),
  newProdType: document.getElementById("newProdType"),
  newProdPrice: document.getElementById("newProdPrice"),
  newProdSeries: document.getElementById("newProdSeries"),
  newProdImage: document.getElementById("newProdImage"),
  newProdPreview: document.getElementById("newProdPreview"),
  addProductBtn: document.getElementById("addProductBtn"),
  updateProductBtn: document.getElementById("updateProductBtn"),

  discountRate: document.getElementById("discountRate"),
  depositRate: document.getElementById("depositRate"),
  saveDiscountBtn: document.getElementById("saveDiscountBtn"),

  invoiceModal: document.getElementById("invoiceModal"),
  invoiceBody: document.getElementById("invoiceBody"),
  printInvoiceBtn: document.getElementById("printInvoiceBtn"),
downloadPdfBtn: document.getElementById("downloadPdfBtn"),



  // filters admin elements
  filtersStages: document.getElementById("filtersStages"),
  filtersGrades: document.getElementById("filtersGrades"),
  filtersSubjects: document.getElementById("filtersSubjects"),
  filtersSeries: document.getElementById("filtersSeries"),
  newStage: document.getElementById("newStage"),
  newGrade: document.getElementById("newGrade"),
  newSubject: document.getElementById("newSubject"),
  newSeries: document.getElementById("newSeries"),
  addStageBtn: document.getElementById("addStageBtn"),
  addGradeBtn: document.getElementById("addGradeBtn"),
  addSubjectBtn: document.getElementById("addSubjectBtn"),
  addSeriesBtn: document.getElementById("addSeriesBtn")
};

/* ---------- UTILITIES ---------- */
function saveAll() {
  localStorage.setItem("xy_products_v2", JSON.stringify(products));
  localStorage.setItem("xy_filters_v2", JSON.stringify(filters));
  localStorage.setItem("xy_discount_v2", JSON.stringify(discountSettings));
}
function showToast(msg, type = "info") {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = "position:fixed;bottom:18px;left:18px;padding:10px 14px;border-radius:8px;color:#fff;z-index:99999";
  el.style.background = type === "error" ? "#e74c3c" : (type === "success" ? "#27ae60" : "#3498db");
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2200);
}
function formatCurrency(n) { return `${Number(n).toFixed(2)} ج.م`; }

/* ---------- TRANSLATION APPLY ---------- */
function applyTranslations() {
  const t = T[currentLang];

  // Main titles
  if (refs.mainTitle) refs.mainTitle.textContent = t.mainTitle;
  if (refs.filterTitle) refs.filterTitle.textContent = t.filterTitle;
  if (refs.searchInput) refs.searchInput.placeholder = t.searchPlaceholder;

  // Filter labels
  if (document.getElementById("stageLbl")) document.getElementById("stageLbl").textContent = t.stageLbl;
  if (document.getElementById("gradeLbl")) document.getElementById("gradeLbl").textContent = t.gradeLbl;
  if (document.getElementById("subjectLbl")) document.getElementById("subjectLbl").textContent = t.subjectLbl;
  if (document.getElementById("seriesLbl")) document.getElementById("seriesLbl").textContent = t.seriesLbl;

  // Tabs (Books / Stationery)
  if (refs.tabBooks) refs.tabBooks.textContent = t.booksTab;
  if (refs.tabStationery) refs.tabStationery.textContent = t.stationeryTab;

  // Cart section
  if (refs.cartTitle) refs.cartTitle.textContent = t.cartTitle;
  if (document.getElementById("lblSubtotalBooks")) document.getElementById("lblSubtotalBooks").textContent = t.subtotalBooks;
  if (document.getElementById("lblSubtotalStationery")) document.getElementById("lblSubtotalStationery").textContent = t.subtotalStationery;
  if (document.getElementById("lblSubtotalAll")) document.getElementById("lblSubtotalAll").textContent = t.subtotalAll;
  if (document.getElementById("lblTotalDiscount")) document.getElementById("lblTotalDiscount").textContent = t.totalDiscount;
  if (document.getElementById("lblDepositAmount")) document.getElementById("lblDepositAmount").textContent = t.depositAmount;
  if (document.getElementById("lblGrandTotal")) document.getElementById("lblGrandTotal").textContent = t.grandTotal;
  if (document.getElementById("lblRemainAmount")) document.getElementById("lblRemainAmount").textContent = t.remainAmount;

  if (refs.btnInvoice) refs.btnInvoice.textContent = t.invoice;
  if (refs.btnClear) refs.btnClear.textContent = t.clearCart;

  // Login + Settings
  if (document.getElementById("loginTitle")) document.getElementById("loginTitle").textContent = t.loginTitle;
  if (document.getElementById("settingsTitle")) document.getElementById("settingsTitle").textContent = t.settingsTitle;

  // Settings Tabs (Products / Filters / Discount)
  if (document.getElementById("productsTabBtn")) document.getElementById("productsTabBtn").textContent = t.productsTab;
  if (document.getElementById("filtersTabBtn")) document.getElementById("filtersTabBtn").textContent = t.filtersTab;
  if (document.getElementById("discountTabBtn")) document.getElementById("discountTabBtn").textContent = t.discountTab;

  // Discount labels
  if (document.getElementById("discountLbl")) document.getElementById("discountLbl").textContent = t.totalDiscount;
  if (document.getElementById("depositLbl")) document.getElementById("depositLbl").textContent = t.depositAmount;
  if (document.getElementById("saveDiscountBtn")) document.getElementById("saveDiscountBtn").textContent = t.saveDiscount;

  // Invoice section
  if (document.getElementById("invoiceTitle")) document.getElementById("invoiceTitle").textContent = t.invoiceTitle;
  if (refs.printInvoiceBtn) refs.printInvoiceBtn.textContent = t.print;
  if (refs.downloadPdfBtn) refs.downloadPdfBtn.innerHTML = `<i class="fas fa-file-pdf"></i> ${t.pdf}`;

  // Customer form (labels + placeholders)
  if (document.querySelector("label[for='custName']")) document.querySelector("label[for='custName']").textContent = t.parentName;
  if (document.querySelector("label[for='custPhone']")) document.querySelector("label[for='custPhone']").textContent = t.phone;
  if (document.querySelector("label[for='custAddress']")) document.querySelector("label[for='custAddress']").textContent = t.address;
  if (document.querySelector("label[for='paymentMethod']")) document.querySelector("label[for='paymentMethod']").textContent = t.payment;

  if (refs.custName) refs.custName.placeholder = t.enterName;
  if (refs.custPhone) refs.custPhone.placeholder = t.phoneEx;
  if (refs.custAddress) refs.custAddress.placeholder = t.addressEx;

  // Payment options
  const paySel = document.getElementById("paymentMethod");
  if (paySel) {
    const instapayOpt = paySel.querySelector("option[value='instapay']");
    const codOpt = paySel.querySelector("option[value='cod']");
    if (instapayOpt) instapayOpt.textContent = t.paymentInstapay;
    if (codOpt) codOpt.textContent = t.paymentCOD;
  }
}

/* ---------- Language toggle ---------- */
refs.langToggle.addEventListener("click", () => {
  currentLang = currentLang === "ar" ? "en" : "ar";
  applyTranslations();
});

/* First call */
applyTranslations();


/* ---------- POPULATE FILTER SELECTS ---------- */
function populateFilterSelects() {
  function fill(selectEl, arr) {
    if (!selectEl) return;
    const allText = currentLang === "ar" ? "الكل" : "All";
    selectEl.innerHTML = `<option value="">${allText}</option>` + arr.map(v => `<option value="${v}">${v}</option>`).join("");
  }
  fill(refs.stageSelect, filters.stages);
  fill(refs.gradeSelect, filters.grades);
  fill(refs.subjectSelect, filters.subjects);
  fill(refs.seriesSelect, filters.series);
}
populateFilterSelects();

/* ---------- RENDER PRODUCTS (with + / - buttons) ---------- */
function renderProducts() {
  refs.booksGrid.innerHTML = "";
  refs.stationeryGrid.innerHTML = "";

  const search = (refs.searchInput.value || "").trim().toLowerCase();
  const stage = refs.stageSelect.value;
  const grade = refs.gradeSelect.value;
  const subject = refs.subjectSelect.value;
  const seriesSel = refs.seriesSelect.value;

  products.forEach(p => {
    if (search && !p.name.toLowerCase().includes(search)) return;
    if (p.type === "book") {
      if ((stage && p.stage !== stage) || (grade && p.grade !== grade) || (subject && p.subject !== subject) || (seriesSel && p.series !== seriesSel)) return;
    }

    const card = document.createElement("div");
    card.className = "product-card";
    const imgSrc = p.image && p.image.length ? p.image : "https://via.placeholder.com/300x200?text=No+Image";
    card.innerHTML = `
      <img class="product-image" src="${imgSrc}" alt="${p.name}">
      <div style="margin-top:8px;font-weight:800">${p.name}</div>
      <div class="product-meta" style="font-size:13px;color:#666;margin-top:6px">
        ${p.type === "book" ? `${p.stage || ""} ${p.grade ? " | " + p.grade : ""} ${p.subject ? " | " + p.subject : ""}` : (p.category || "")}
      </div>
      <div class="product-footer">
        <div style="font-weight:800">${formatCurrency(p.price)}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-outline btn-decrease" data-id="${p.id}">${T[currentLang].decrease}</button>
          <button class="btn btn-primary btn-increase" data-id="${p.id}">${T[currentLang].increase}</button>
        </div>
      </div>
    `;

    card.querySelector(".btn-increase").addEventListener("click", (e) => { addToCart(p.id); });
    card.querySelector(".btn-decrease").addEventListener("click", (e) => { decreaseCartQty(p.id); });

    if (p.type === "book") refs.booksGrid.appendChild(card); else refs.stationeryGrid.appendChild(card);
  });
}

/* ---------- CART FUNCTIONS & CALCULATIONS ---------- */
function addToCart(id) {
  const prod = products.find(x => x.id === id);
  if (!prod) return;
  const it = cart.find(c => c.id === id);
  if (it) it.qty += 1; else cart.push({ ...prod, qty: 1 });
  renderCart();
}
function decreaseCartQty(id) {
  const it = cart.find(c => c.id === id);
  if (!it) return;
  it.qty -= 1;
  if (it.qty <= 0) cart = cart.filter(c => c.id !== id);
  renderCart();
}
function removeFromCart(id) {
  cart = cart.filter(c => c.id !== id);
  renderCart();
}

function renderCart() {
  refs.cartItems.innerHTML = "";
  let booksTotal = 0, stationeryTotal = 0;
  cart.forEach(item => {
    const row = document.createElement("div");
    row.className = "cart-item";
    row.innerHTML = `
      <div style="max-width:60%"><strong>${item.name}</strong><div style="color:#666;font-size:13px">${item.qty} × ${formatCurrency(item.price)}</div></div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div style="font-weight:800">${formatCurrency(item.qty * item.price)}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-outline small-dec" data-id="${item.id}">-</button>
          <button class="btn btn-outline small-inc" data-id="${item.id}">+</button>
          <button class="btn btn-outline" data-del="${item.id}"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    refs.cartItems.appendChild(row);

    row.querySelector(".small-inc").addEventListener("click", () => { addToCart(item.id); });
    row.querySelector(".small-dec").addEventListener("click", () => { decreaseCartQty(item.id); });
    row.querySelector("[data-del]").addEventListener("click", () => { removeFromCart(item.id); });

    if (item.type === "book") booksTotal += item.qty * item.price; else stationeryTotal += item.qty * item.price;
  });

  const subtotal = booksTotal + stationeryTotal;
  const discountValue = subtotal * (discountSettings.discountRate / 100);
  const afterDiscount = Math.max(0, subtotal - discountValue);
  const deposit = afterDiscount * (discountSettings.depositRate / 100);
  const remain = Math.max(0, afterDiscount - deposit);

  refs.subtotalBooks.textContent = formatCurrency(booksTotal);
  refs.subtotalStationery.textContent = formatCurrency(stationeryTotal);
  refs.subtotalAll.textContent = formatCurrency(subtotal);
  refs.totalDiscount.textContent = formatCurrency(discountValue);
  refs.depositAmount.textContent = formatCurrency(deposit);
  refs.grandTotal.textContent = formatCurrency(afterDiscount);
  refs.remainAmount.textContent = formatCurrency(remain);

  refs.btnInvoice.disabled = cart.length === 0;
}

/* ---------- TAB NAVIGATION (Books / Stationery) ---------- */
refs.tabBooks.addEventListener("click", () => {
  refs.tabBooks.classList.add("active");
  refs.tabStationery.classList.remove("active");
  refs.booksGrid.style.display = "grid";
  refs.stationeryGrid.style.display = "none";
});
refs.tabStationery.addEventListener("click", () => {
  refs.tabStationery.classList.add("active");
  refs.tabBooks.classList.remove("active");
  refs.stationeryGrid.style.display = "grid";
  refs.booksGrid.style.display = "none";
});

/* ---------- SEARCH / FILTER LISTENERS ---------- */
[refs.searchInput, refs.stageSelect, refs.gradeSelect, refs.subjectSelect, refs.seriesSelect].forEach(el => {
  if (!el) return;
  el.addEventListener("input", debounce(renderProducts, 180));
  el.addEventListener("change", renderProducts);
});

/* ---------- DEBOUNCE helper ---------- */
function debounce(fn, wait) {
  let t;
  return function (...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

/* ---------- LOGIN & SETTINGS ---------- */
refs.btnClear.addEventListener("click", () => {
  if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
  if (!confirm(T[currentLang].confirmClearCart)) return;
  cart = [];
  renderCart();
});

refs.btnInvoice.addEventListener("click", () => { openInvoiceModal(); });

refs.btnInvoice.disabled = true; // initially

document.getElementById("btnSettings").addEventListener("click", () => {
  refs.adminEmail.value = "";
  refs.adminPassword.value = "";
  refs.loginModal.classList.add("show");
});

refs.loginSubmit.addEventListener("click", () => {
  const e = (refs.adminEmail.value || "").trim();
  const p = (refs.adminPassword.value || "").trim();
  if (e === ADMIN.email && p === ADMIN.password) {
    refs.loginModal.classList.remove("show");
    refs.settingsModal.classList.add("show");
    onSettingsOpen();
  } else {
    showToast(T[currentLang].loginWrong, "error");
  }
});

refs.settingsTabs.forEach(btn => {
  btn.addEventListener("click", () => {
    refs.settingsTabs.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    refs.settingsPanels.forEach(p => p.classList.remove("active"));
    const target = btn.dataset.tab;
    const panel = document.getElementById(target);
    if (panel) panel.classList.add("active");
  });
});

document.querySelectorAll(".modal .close").forEach(btn => {
  btn.addEventListener("click", (e) => {
    const modal = btn.closest(".modal");
    if (modal) modal.classList.remove("show");
  });
});

/* ---------- ADMIN: Products management (add / edit / delete + image upload) ---------- */
let editingProductId = null;

function renderProductsAdmin() {
  refs.productsList.innerHTML = "";
  products.forEach(p => {
    const row = document.createElement("div");
    row.style = "display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #f0f0f0";
    row.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
        <img src="${p.image && p.image.length ? p.image : 'https://via.placeholder.com/80'}" class="xy-thumb" alt="">
        <div><strong>${p.name}</strong><div style="font-size:12px;color:#666">${p.type === 'book' ? (p.stage ? p.stage + " | " : "") + (p.grade ? p.grade + " | " : "") + (p.subject ? p.subject : "") : (p.category || "")}</div></div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <div style="font-weight:800">${formatCurrency(p.price)}</div>
        <button class="btn btn-outline" data-edit="${p.id}"><i class="fas fa-edit"></i></button>
        <button class="btn btn-outline" data-del="${p.id}"><i class="fas fa-trash"></i></button>
      </div>`;
    refs.productsList.appendChild(row);

    row.querySelector("[data-edit]").addEventListener("click", () => { startEditProduct(p.id); });
    row.querySelector("[data-del]").addEventListener("click", () => {
      if (!confirm(T[currentLang].deleted + "؟")) return;
      products = products.filter(x => x.id !== p.id);
      saveAll();
      renderProducts();
      renderProductsAdmin();
      showToast(T[currentLang].productRemoved, "success");
    });
  });
}

function startEditProduct(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  editingProductId = id;
  refs.newProdName.value = p.name || "";
  refs.newProdType.value = p.type || "book";
  refs.newProdPrice.value = p.price || 0;
  refs.newProdSeries.value = p.series || p.category || "";
  if (p.image) { refs.newProdPreview.src = p.image; refs.newProdPreview.style.display = "block"; } else { refs.newProdPreview.style.display = "none"; }
}

refs.newProdImage.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) { refs.newProdPreview.style.display = "none"; refs.newProdPreview.src = ""; return; }
  const reader = new FileReader();
  reader.onload = () => {
    refs.newProdPreview.src = reader.result;
    refs.newProdPreview.style.display = "block";
  };
  reader.readAsDataURL(file);
});

refs.addProductBtn.addEventListener("click", () => {
  const name = (refs.newProdName.value || "").trim();
  const type = refs.newProdType.value;
  const price = parseFloat(refs.newProdPrice.value) || 0;
  const seriesOrCat = (refs.newProdSeries.value || "").trim();
  let imageData = "";
  if (refs.newProdPreview.src && refs.newProdPreview.style.display !== "none") {
    imageData = refs.newProdPreview.src;
  }
  if (!name) { showToast(currentLang === "ar" ? T.ar.enterProdName : T.en.enterProdName, "error"); return; }
  const id = Date.now();
  const item = type === "book" ? { id, type: "book", name, price, stage: filters.stages[0] || "", grade: filters.grades[0] || "", subject: filters.subjects[0] || "", series: seriesOrCat, image: imageData } : { id, type: "stationery", name, price, category: seriesOrCat, image: imageData };
  products.push(item);
  saveAll();
  renderProducts();
  renderProductsAdmin();
  refs.newProdName.value = "";
  refs.newProdPrice.value = "";
  refs.newProdSeries.value = "";
  refs.newProdImage.value = "";
  refs.newProdPreview.style.display = "none";
  refs.newProdPreview.src = "";
  showToast(T[currentLang].productAdded, "success");
});

refs.updateProductBtn.addEventListener("click", () => {
  if (!editingProductId) { showToast(currentLang === "ar" ? T.ar.noEdit : T.en.noEdit, "error"); return; }
  const p = products.find(x => x.id === editingProductId);
  if (!p) return;
  p.name = (refs.newProdName.value || "").trim();
  p.type = refs.newProdType.value;
  p.price = parseFloat(refs.newProdPrice.value) || 0;
  p.series = (refs.newProdSeries.value || "").trim();
  if (refs.newProdPreview.src && refs.newProdPreview.style.display !== "none") p.image = refs.newProdPreview.src;
  saveAll();
  renderProducts();
  renderProductsAdmin();
  editingProductId = null;
  refs.newProdName.value = ""; refs.newProdPrice.value = ""; refs.newProdSeries.value = ""; refs.newProdImage.value = ""; refs.newProdPreview.style.display = "none";
  showToast(T[currentLang].productUpdated, "success");
});

/* ---------- ADMIN: Filters management (add / delete) ---------- */
function renderFiltersAdmin() {
  function renderList(containerEl, arr, type) {
    containerEl.innerHTML = "";
    arr.forEach((item, i) => {
      const div = document.createElement("div");
      div.style = "display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px";
      div.innerHTML = `<span>${item}</span><button class="btn btn-outline" data-del="${type}-${i}"><i class="fas fa-trash"></i></button>`;
      containerEl.appendChild(div);
      div.querySelector("[data-del]").addEventListener("click", () => {
        filters[type].splice(i, 1);
        saveAll();
        renderFiltersAdmin();
        populateFilterSelects();
        showToast(T[currentLang].filtersSaved, "success");
      });
    });
  }
  renderList(refs.filtersStages, filters.stages, "stages");
  renderList(refs.filtersGrades, filters.grades, "grades");
  renderList(refs.filtersSubjects, filters.subjects, "subjects");
  renderList(refs.filtersSeries, filters.series, "series");
}

refs.addStageBtn.addEventListener("click", () => {
  const val = (refs.newStage.value || "").trim();
  if (!val) return;
  if (!filters.stages.includes(val)) filters.stages.push(val);
  refs.newStage.value = "";
  saveAll(); renderFiltersAdmin(); populateFilterSelects();
  showToast(T[currentLang].filtersSaved, "success");
});
refs.addGradeBtn.addEventListener("click", () => {
  const val = (refs.newGrade.value || "").trim();
  if (!val) return;
  if (!filters.grades.includes(val)) filters.grades.push(val);
  refs.newGrade.value = "";
  saveAll(); renderFiltersAdmin(); populateFilterSelects();
  showToast(T[currentLang].filtersSaved, "success");
});
refs.addSubjectBtn.addEventListener("click", () => {
  const val = (refs.newSubject.value || "").trim();
  if (!val) return;
  if (!filters.subjects.includes(val)) filters.subjects.push(val);
  refs.newSubject.value = "";
  saveAll(); renderFiltersAdmin(); populateFilterSelects();
  showToast(T[currentLang].filtersSaved, "success");
});
refs.addSeriesBtn.addEventListener("click", () => {
  const val = (refs.newSeries.value || "").trim();
  if (!val) return;
  if (!filters.series.includes(val)) filters.series.push(val);
  refs.newSeries.value = "";
  saveAll(); renderFiltersAdmin(); populateFilterSelects();
  showToast(T[currentLang].filtersSaved, "success");
});

/* ---------- ADMIN: Discount save ---------- */
refs.saveDiscountBtn.addEventListener("click", () => {
  discountSettings.discountRate = parseFloat(refs.discountRate.value) || 0;
  discountSettings.depositRate = parseFloat(refs.depositRate.value) || 0;
  saveAll();
  renderCart();
  showToast(T[currentLang].saveDiscount, "success");
});

/* ---------- INVOICE / PRINT / WHATSAPP ---------- */
function openInvoiceModal() {
  if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
  let html = `<p><strong>${T[currentLang].invoiceTitle}</strong></p>`;
  html += `<p><strong>${T[currentLang].parentName || "Client"}:</strong> ${refs.custName.value || "-" }<br>`;
  html += `<strong>${T[currentLang].phone || "Phone"}:</strong> ${refs.custPhone.value || "-" }<br>`;
  html += `<strong>${T[currentLang].address || "Address"}:</strong> ${refs.custAddress.value || "-" }</p>`;
  html += `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f0f0f0"><th style="padding:6px;border:1px solid #eee">المنتج</th><th style="padding:6px;border:1px solid #eee">الكمية</th><th style="padding:6px;border:1px solid #eee">السعر</th><th style="padding:6px;border:1px solid #eee">الإجمالي</th></tr></thead><tbody>`;
  cart.forEach(i => {
    html += `<tr><td style="padding:6px;border:1px solid #eee">${i.name}</td><td style="padding:6px;border:1px solid #eee">${i.qty}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.price)}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.qty * i.price)}</td></tr>`;
  });
  html += `</tbody></table>`;
  html += `<p><strong>${T[currentLang].subtotalAll}</strong> ${refs.subtotalAll.textContent}<br>`;
  html += `<strong>${T[currentLang].totalDiscount}</strong> ${refs.totalDiscount.textContent}<br>`;
  html += `<strong>${T[currentLang].grandTotal}</strong> ${refs.grandTotal.textContent}<br>`;
  html += `<strong>${T[currentLang].depositAmount}</strong> ${refs.depositAmount.textContent}<br>`;
  html += `<strong>${T[currentLang].remainAmount}</strong> ${refs.remainAmount.textContent}</p>`;

  refs.invoiceBody.innerHTML = html;
  refs.invoiceModal.classList.add("show");
}
refs.printInvoiceBtn.addEventListener("click", () => { window.print(); });
refs.downloadPdfBtn.addEventListener("click", () => {
  const { jsPDF } = window.jspdf;
  const invoiceElement = document.getElementById("invoiceModal");

  html2canvas(invoiceElement, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "pt", "a4");

    const imgWidth = 595;
    const pageHeight = 842;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // ✅ إنزال الملف إجباري على كل الأجهزة
    const pdfBlob = pdf.output("blob");
    const link = document.createElement("a");
    link.href = URL.createObjectURL(pdfBlob);
    link.download = "invoice.pdf";  // اسم الملف
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  });
});


/* ---------- SETTINGS OPEN initial sync ---------- */
function onSettingsOpen() {
  renderProductsAdmin();
  refs.discountRate.value = discountSettings.discountRate;
  refs.depositRate.value = discountSettings.depositRate;
  renderFiltersAdmin();
}

/* ---------- INITIALIZATION ---------- */
function init() {
  applyTranslations();
  populateFilterSelects();
  renderProducts();
  renderCart();
  document.querySelectorAll(".modal .close").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const modal = btn.closest(".modal");
      if (modal) modal.classList.remove("show");
    });
  });
}
init();

/* ---------- expose some helpers for inline onclicks if needed ---------- */
window.addToCart = addToCart;
window.decreaseQty = decreaseCartQty;

/* ---------- End of script ---------- */
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
