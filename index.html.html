<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام XY لإدارة الطلبات</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- إضافة Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    /* أنماط CSS المعدلة للون الأسود والذهبي */
    :root {
      --gold: #D4AF37;
      --dark-gold: #B8860B;
      --black: #000000;
      --dark-gray: #1a1a1a;
      --light-gray: #333333;
      --text-light: #cccccc;
      --white: #ffffff;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: var(--black);
      color: var(--text-light);
      direction: rtl;
    }
    
    header {
      background: linear-gradient(to right, var(--black), var(--dark-gray));
      color: var(--gold);
      padding: 12px 16px;
      border-bottom: 2px solid var(--gold);
      text-align: center;
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      border: 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-primary:hover {
      background: var(--dark-gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);
    }
    
    .btn-accent {
      background: var(--dark-gray);
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    
    .btn-accent:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
    }
    
    .btn-outline:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-danger {
      background: #8B0000;
      color: var(--white);
    }
    
    .btn-danger:hover {
      background: #A52A2A;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      padding: 14px;
    }
    
    .panel {
      background: var(--dark-gray);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--light-gray);
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    
    .filter-input, .filter-select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .tabs {
      display: flex;
      gap: 6px;
      margin: 8px 0;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .product-card {
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      background: var(--black);
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
    }
    
    .product-image {
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--dark-gray);
    }
    
    .preview-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--light-gray);
      margin: 4px 2px;
    }

    .preview-container {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 4px 0;
    }

    .preview-container::-webkit-scrollbar {
      height: 6px;
    }

    .preview-container::-webkit-scrollbar-thumb {
      background-color: var(--gold);
      border-radius: 3px;
    }

    .preview-container img.preview-thumb {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--light-gray);
      flex-shrink: 0;
    }
    
    .product-details-images {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
    }
    
    .product-details-images img {
      height: 150px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid #444;
    }
    
    .product-info {
      margin-top: 10px;
    }
    
    .product-info h3 {
      color: var(--gold);
      margin-bottom: 8px;
    }

    .product-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--light-gray);
    }
    
    .sidebar .summary-item {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      padding: 4px 0;
      border-bottom: 1px dashed var(--light-gray);
    }
    
    .cart-items {
      max-height: 220px;
      overflow: auto;
      margin: 10px 0;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--dark-gray);
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      border: 2px solid var(--gold);
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }
    
    .close {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--gold);
    }
    
    .settings-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 15px;
    }
    
    .settings-tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .settings-tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .settings-panel {
      display: none;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .xy-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 4px;
      border: 1px solid var(--light-gray);
    }
    
    h2, h3, h4 {
      color: var(--gold);
      margin: 12px 0;
    }
    
    label {
      color: var(--text-light);
      margin-bottom: 5px;
      display: block;
    }
    
    /* الأسعار باللون الذهبي */
    #subtotalBooks, #subtotalStationery, #subtotalAll,
    #totalDiscount, #depositAmount, #grandTotal, #remainAmount,
    .product-footer div:first-child {
      color: var(--gold);
      font-weight: bold;
    }
    
    /* تحسينات للعناوين */
    .panel-header {
      border-bottom: 1px solid var(--gold);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    /* تحسينات الموبايل */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="mainTitle"><i class="fas fa-book"></i> نظام XY</h1>
    <div>
      <button id="langToggle" class="btn btn-outline">English</button>
      <button id="btnSettings" class="btn btn-primary"><i class="fas fa-cog"></i> إعدادات</button>
    </div>
  </header>

  <div class="container">
    <!-- المنتجات -->
    <div class="panel">
      <h3 id="filterTitle">خيارات البحث والتصفية</h3>
      <input id="searchInput" class="filter-input" placeholder="ابحث باسم المنتج...">
      <div class="filter-row">
        <div class="filter-group book-only">
          <label id="stageLbl">المرحلة</label>
          <select id="stageSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="gradeLbl">الصف</label>
          <select id="gradeSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="subjectLbl">المادة</label>
          <select id="subjectSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="seriesLbl">السلسلة</label>
          <select id="seriesSelect" class="filter-select"></select>
        </div>
      </div>
      <div class="tabs">
        <button id="tabBooks" class="tab active">كتب خارجية</button>
        <button id="tabStationery" class="tab">أدوات مكتبية</button>
      </div>
      <div id="booksGrid" class="products-grid"></div>
      <div id="stationeryGrid" class="products-grid" style="display:none"></div>
    </div>

    <!-- السلة -->
   <aside class="sidebar panel">
      <h3 id="cartTitle">سلة المشتريات</h3>

      <div class="panel" style="margin-bottom:10px">
        <label for="custName">اسم ولي الأمر</label>
        <input id="custName" class="filter-input">
        <label for="custPhone">رقم الهاتف</label>
        <input id="custPhone" class="filter-input">
        <label for="custAddress">العنوان</label>
        <input id="custAddress" class="filter-input">
        <label for="paymentMethod">طريقة الدفع</label>
        <select id="paymentMethod" class="filter-input">
          <option value="instapay">انستاباي</option>
          <option value="cod">الدفع عند الاستلام</option>
        </select>
      </div>
      <div id="cartItems" class="cart-items"></div>
      <div class="summary">
        <div class="summary-item"><span id="lblSubtotalBooks">إجمالي الكتب:</span><span id="subtotalBooks">0 ج.م</span></div>
        <div class="summary-item"><span id="lblSubtotalStationery">إجمالي الأدوات:</span><span id="subtotalStationery">0 ج.م</span></div>
        <div class="summary-item"><span id="lblSubtotalAll">المجموع قبل الخصم:</span><span id="subtotalAll">0 ج.م</span></div>
        <div class="summary-item"><span id="lblTotalDiscount">قيمة الخصم:</span><span id="totalDiscount">0 ج.م</span></div>
        <div class="summary-item"><span id="lblDepositAmount">المقدم:</span><span id="depositAmount">0 ج.م</span></div>
        <div class="summary-item"><span id="lblGrandTotal">الإجمالي النهائي:</span><span id="grandTotal">0 ج.م</span></div>
        <div class="summary-item"><span id="lblRemainAmount">المتبقي عند الاستلام:</span><span id="remainAmount">0 ج.م</span></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="btnInvoice" class="btn btn-primary" style="flex:1">فاتورة</button>
        <button id="btnClear" class="btn btn-danger" style="flex:1">تفريغ</button>
      </div>
    </aside>
  </div>

  <!-- نافذة تسجيل الدخول -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('loginModal').classList.remove('show')">&times;</button>
      <h3 id="loginTitle">تسجيل الدخول</h3>
      <input id="adminEmail" placeholder="Email" class="filter-input">
      <input id="adminPassword" type="password" placeholder="Password" class="filter-input">
      <button id="loginSubmit" class="btn btn-primary">دخول</button>
    </div>
  </div>

  <!-- نافذة الإعدادات -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('settingsModal').classList.remove('show')">&times;</button>
      <h3 id="settingsTitle">إعدادات الإدارة</h3>
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="productsPanel">المنتجات</button>
        <button class="settings-tab" data-tab="discountPanel">الخصم</button>
        <button class="settings-tab" data-tab="filtersPanel">الفلاتر</button>
      </div>

      <!-- المنتجات -->
      <div id="productsPanel" class="settings-panel active">
        <h4>قائمة المنتجات</h4>
        <div id="productsList"></div>
        <h4>إضافة / تعديل منتج</h4>
        <input id="newProdName" placeholder="اسم المنتج" class="filter-input">
        <select id="newProdType" class="filter-input">
          <option value="book">كتاب</option>
          <option value="stationery">أداة مكتبية</option>
        </select>
          <input id="newProdPrice" type="number" placeholder="السعر" class="filter-input">

  <!-- 👇 اضفت السيريـز أو التصنيف -->
  <input id="newProdSeries" placeholder="السلسلة / التصنيف" class="filter-input">

  <!-- رفع عدة صور -->
  <input id="newProdImages" type="file" accept="image/*" multiple class="filter-input">
  <div id="newProdPreviewList" class="preview-container"></div>

  <div style="margin-top:6px;display:flex;gap:6px">
    <button id="addProductBtn" class="btn btn-primary" style="flex:1">إضافة</button>
    <button id="updateProductBtn" class="btn btn-accent" style="flex:1">تحديث</button>
  </div>
</div>

      <!-- الخصم -->
      <div id="discountPanel" class="settings-panel">
        <h4>إعداد الخصم</h4>
        <label>نسبة الخصم %</label>
        <input id="discountRate" type="number" class="filter-input">
        <label>نسبة المقدم %</label>
        <input id="depositRate" type="number" class="filter-input">
        <button id="saveDiscountBtn" class="btn btn-primary" style="margin-top:6px">حفظ</button>
      </div>

      <!-- الفلاتر -->
      <div id="filtersPanel" class="settings-panel">
        <h4>إدارة الفلاتر</h4>

        <div style="margin-top:8px">
          <label>المراحل</label>
          <div id="filtersStages"></div>
          <div class="small-field">
            <input id="newStage" class="filter-input" placeholder="أدخل مرحلة جديدة">
            <button id="addStageBtn" class="btn btn-primary">إضافة مرحلة</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>الصفوف</label>
          <div id="filtersGrades"></div>
          <div class="small-field">
            <input id="newGrade" class="filter-input" placeholder="أدخل صف جديد">
            <button id="addGradeBtn" class="btn btn-primary">إضافة صف</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>المواد</label>
          <div id="filtersSubjects"></div>
          <div class="small-field">
            <input id="newSubject" class="filter-input" placeholder="أدخل مادة جديدة">
            <button id="addSubjectBtn" class="btn btn-primary">إضافة مادة</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>السلاسل</label>
          <div id="filtersSeries"></div>
          <div class="small-field">
            <input id="newSeries" class="filter-input" placeholder="أدخل سلسلة جديدة">
            <button id="addSeriesBtn" class="btn btn-primary">إضافة سلسلة</button>
          </div>
        </div>

      </div>
    </div>
  </div>
  <!-- نافذة الفاتورة -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('invoiceModal').classList.remove('show')">&times;</button>
      <h3 id="invoiceTitle">فاتورة الطلب</h3>
      <div id="invoiceBody"></div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="printInvoiceBtn" class="btn btn-primary">طباعة</button>
        <button id="downloadPdfBtn" class="btn btn-primary">تحميل PDF</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="productModal">
    <div class="modal-content">
      <button class="close" id="closeProductModal">&times;</button>
      <div id="productDetails"></div>
    </div>
  </div>

  <!-- روابط للسكربتات الخارجية (تحت جزء الـ JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    /* =========================
       تهيئة Firebase
       ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyDWsDR3WlS2JXi-Xp5Tp-70lioa5saroII",
      authDomain: "online-store-e2c20.firebaseapp.com",
      projectId: "online-store-e2c20",
      storageBucket: "online-store-e2c20.firebasestorage.app",
      messagingSenderId: "176583372373",
      appId: "1:176583372373:web:68594825749587b6446edc"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    /* =========================
       XY System - JavaScript مع دعم Firebase
       ========================= */


    let currentLang = "ar";

    /* ---------- البيانات (سيتم تحميلها من Firebase) ---------- */
    let products = [];
    let filters = {
      stages: ["الابتدائية", "الإعدادية", "الثانوية"],
      grades: ["الصف الأول", "الصف الثاني", "الصف الثالث", "الصف الرابع", "الصف الخامس"],
      subjects: ["اللغة العربية", "الرياضيات", "العلوم", "الإنجليزية"],
      series: ["سلسلة النجاح", "سلسلة التميز", "سلسلة التفوق"]
    };
    let discountSettings = { discountRate: 0, depositRate: 40 };
    let cart = [];
    let editingProductId = null;

    /* ---------- دوال Firebase ---------- */
    async function loadDataFromFirebase() {
      try {
        // تحميل المنتجات
        const productsSnapshot = await db.collection("products").get();
        products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // تحميل الفلاتر
        const filtersDoc = await db.collection("settings").doc("filters").get();
        if (filtersDoc.exists) {
          filters = filtersDoc.data();
        }
        
        // تحميل إعدادات الخصم
        const discountDoc = await db.collection("settings").doc("discount").get();
        if (discountDoc.exists) {
          discountSettings = discountDoc.data();
        }
        
        // بعد تحميل البيانات، نحدث الواجهة
        renderProducts();
        populateFilterSelects();
        renderCart();
        
        console.log("تم تحميل البيانات من Firebase");
      } catch (error) {
        console.error("خطأ في تحميل البيانات من Firebase:", error);
        // في حالة الخطأ، نستخدم البيانات المحلية
        loadFromLocalStorage();
      }
    }

    async function saveAllToFirebase() {
      try {
        // حفظ المنتجات
        const batch = db.batch();
        const productsRef = db.collection("products");
        
        // حذف جميع المنتجات الحالية أولاً
        const snapshot = await productsRef.get();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        // إضافة المنتجات الجديدة
        products.forEach(product => {
          // تأكد من أن ال id هو نص وليس رقم
          const docRef = productsRef.doc(product.id.toString());
          
          // إنشاء نسخة من المنتج بدون خاصية id
          const { id, ...productData } = product;
          batch.set(docRef, productData);
        });
        
        await batch.commit();
        
        // حفظ الفلاتر
        await db.collection("settings").doc("filters").set(filters);
        
        // حفظ إعدادات الخصم
        await db.collection("settings").doc("discount").set(discountSettings);
        
        console.log("تم حفظ البيانات في Firebase");
        showToast("تم حفظ البيانات في السحابة", "success");
        return true;
      } catch (error) {
        console.error("خطأ في حفظ البيانات في Firebase:", error);
        showToast("خطأ في الحفظ على السحابة", "error");
        throw error;
      }
    }

    function setupRealtimeListeners() {
      // الاستماع لتحديثات المنتجات
      db.collection("products").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added" || change.type === "modified") {
            const productData = { id: change.doc.id, ...change.doc.data() };
            const index = products.findIndex(p => p.id == productData.id);
            
            if (index !== -1) {
              products[index] = productData;
            } else {
              products.push(productData);
            }
          } else if (change.type === "removed") {
            products = products.filter(p => p.id != change.doc.id);
          }
        });
        
        renderProducts();
      });

      // الاستماع لتحديثات الفلاتر
      db.collection("settings").doc("filters").onSnapshot(doc => {
        if (doc.exists) {
          filters = doc.data();
          populateFilterSelects();
        }
      });

      // الاستماع لتحديثات إعدادات الخصم
      db.collection("settings").doc("discount").onSnapshot(doc => {
        if (doc.exists) {
          discountSettings = doc.data();
          renderCart();
        }
      });
    }

    // دوال النسخ الاحتياطي المحلي
    function saveToLocalStorage() {
      localStorage.setItem("xy_products_v2", JSON.stringify(products));
      localStorage.setItem("xy_filters_v2", JSON.stringify(filters));
      localStorage.setItem("xy_discount_v2", JSON.stringify(discountSettings));
    }

    function loadFromLocalStorage() {
      const savedProducts = JSON.parse(localStorage.getItem("xy_products_v2"));
      const savedFilters = JSON.parse(localStorage.getItem("xy_filters_v2"));
      const savedDiscount = JSON.parse(localStorage.getItem("xy_discount_v2"));
      
      if (savedProducts) products = savedProducts;
      if (savedFilters) filters = savedFilters;
      if (savedDiscount) discountSettings = savedDiscount;
      
      renderProducts();
      populateFilterSelects();
      renderCart();
    }

    // تعديل دالة saveAll لاستخدام Firebase
    function saveAll() {
      // حفظ في Firebase أولاً
      saveAllToFirebase().then(() => {
        // ثم حفظ نسخة احتياطية محلياً
        saveToLocalStorage();
      }).catch(error => {
        console.error("خطأ في الحفظ على Firebase:", error);
        // في حالة الخطأ، نحفظ محلياً فقط
        saveToLocalStorage();
      });
    }
    /* ---------- TRANSLATIONS ---------- */
    const T = {
      ar: {
        pageTitle: "نظام XY لإدارة الطلبات",
        mainTitle: "نظام XY",
        langText: "English",
        filterTitle: "خيارات البحث والتصفية",
        searchPlaceholder: "ابحث باسم المنتج...",
        stageLbl: "المرحلة",
        gradeLbl: "الصف",
        subjectLbl: "المادة",
        seriesLbl: "السلسلة",
        booksTab: "كتب خارجية",
        stationeryTab: "أدوات مكتبية",
        cartTitle: "سلة المشتريات",
        parentName: "اسم ولي الأمر",
        enterName: "أدخل الاسم الكامل",
        phone: "رقم الهاتف",
        phoneEx: "مثال: 20123456789",
        address: "العنوان",
        addressEx: "المدينة / المنطقة",
        payment: "طريقة الدفع",
        paymentInstapay: "انستاباي",
        paymentCOD: "عند الاستلام",
        subtotalBooks: "إجمالي الكتب:",
        subtotalStationery: "إجمالي الأدوات:",
        subtotalAll: "المجموع قبل الخصم:",
        totalDiscount: "قيمة الخصم:",
        depositAmount: "المقدم:",
        grandTotal: "الإجمالي النهائي:",
        remainAmount: "المتبقي عند الاستلام:",
        invoice: "فاتورة",
        export: "تصدير CSV",
        clearCart: "تفريغ",
        loginTitle: "تسجيل الدخول",
        settingsTitle: "إعدادات الإدارة",
        productsTab: "المنتجات",
        discountTab: "الخصم",
        addProd: "إضافة",
        updateProd: "تحديث",
        refreshProd: "تحديث العرض",
        saveDiscount: "حفظ",
        loginWrong: "بيانات الدخول غير صحيحة",
        productAdded: "تم إضافة المنتج",
        productUpdated: "تم تحديث المنتج",
        productRemoved: "تم حذف المنتج",
        filtersSaved: "تم حفظ الفلاتر",
        csvSaved: "تم تنزيل CSV",
        invoiceTitle: "فاتورة الطلب",
        print: "طباعة",
        pdf: "تحميل pdf",
        whatsapp: "إرسال واتساب",
        cartEmpty: "السلة فارغة",
        confirmClearCart: "هل تريد تفريغ السلة؟",
        increase: "+",
        decrease: "-",
        deleted: "تم الحذف",
        enterPhone: "أدخل رقم الموبايل",
        enterProdName: "ادخل اسم المنتج",
        noEdit: "لا توجد عملية تعديل",
      },
      en: {
        pageTitle: "XY Order System",
        mainTitle: "XY System",
        langText: "العربية",
        filterTitle: "Search & Filters",
        searchPlaceholder: "Search product name...",
        stageLbl: "Stage",
        gradeLbl: "Grade",
        subjectLbl: "Subject",
        seriesLbl: "Series",
        booksTab: "Books",
        stationeryTab: "Stationery",
        cartTitle: "Shopping Cart",
        parentName: "Parent Name",
        enterName: "Enter full name",
        phone: "Phone",
        phoneEx: "Example: 20123456789",
        address: "Address",
        addressEx: "City / Area",
        payment: "Payment Method",
        paymentInstapay: "Instapay",
        paymentCOD: "Cash on Delivery",
        subtotalBooks: "Books Total:",
        subtotalStationery: "Stationery Total:",
        subtotalAll: "Subtotal:",
        totalDiscount: "Discount:",
        depositAmount: "Deposit:",
        grandTotal: "Final Total:",
        remainAmount: "Remaining:",
        invoice: "Invoice",
        export: "Export CSV",
        clearCart: "Clear",
        loginTitle: "Login",
        settingsTitle: "Admin Settings",
        productsTab: "Products",
        discountTab: "Discount",
        addProd: "Add",
        updateProd: "Update",
        refreshProd: "Refresh",
        saveDiscount: "Save",
        loginWrong: "Credentials incorrect",
        productAdded: "Product added",
        productUpdated: "Product updated",
        productRemoved: "Product removed",
        filtersSaved: "Filters saved",
        csvSaved: "CSV downloaded",
        invoiceTitle: "Order Invoice",
        print: "Print",
        pdf: "download pdf",
        whatsapp: "Send WhatsApp",
        cartEmpty: "Cart is empty",
        confirmClearCart: "Clear cart?",
        increase: "+",
        decrease: "-",
        deleted: "Deleted",
        enterPhone: "Enter phone number",
        enterProdName: "Enter product name",
        noEdit: "No product selected",
      }
    };

    /* ---------- DOM refs ---------- */
    const refs = {
      langToggle: document.getElementById("langToggle"),
      mainTitle: document.getElementById("mainTitle"),
      filterTitle: document.getElementById("filterTitle"),
      searchInput: document.getElementById("searchInput"),
      stageSelect: document.getElementById("stageSelect"),
      gradeSelect: document.getElementById("gradeSelect"),
      subjectSelect: document.getElementById("subjectSelect"),
      seriesSelect: document.getElementById("seriesSelect"),
      tabBooks: document.getElementById("tabBooks"),
      tabStationery: document.getElementById("tabStationery"),
      booksGrid: document.getElementById("booksGrid"),
      stationeryGrid: document.getElementById("stationeryGrid"),

      cartTitle: document.getElementById("cartTitle"),
      custName: document.getElementById("custName"),
      custPhone: document.getElementById("custPhone"),
      custAddress: document.getElementById("custAddress"),
      cartItems: document.getElementById("cartItems"),
      subtotalBooks: document.getElementById("subtotalBooks"),
      subtotalStationery: document.getElementById("subtotalStationery"),
      subtotalAll: document.getElementById("subtotalAll"),
      totalDiscount: document.getElementById("totalDiscount"),
      depositAmount: document.getElementById("depositAmount"),
      grandTotal: document.getElementById("grandTotal"),
      remainAmount: document.getElementById("remainAmount"),

      btnInvoice: document.getElementById("btnInvoice"),
      btnClear: document.getElementById("btnClear"),

      loginModal: document.getElementById("loginModal"),
      loginSubmit: document.getElementById("loginSubmit"),
      adminEmail: document.getElementById("adminEmail"),
      adminPassword: document.getElementById("adminPassword"),

      settingsModal: document.getElementById("settingsModal"),
      settingsTabs: document.querySelectorAll(".settings-tab"),
      settingsPanels: document.querySelectorAll(".settings-panel"),
      productsList: document.getElementById("productsList"),
      newProdName: document.getElementById("newProdName"),
      newProdType: document.getElementById("newProdType"),
      newProdPrice: document.getElementById("newProdPrice"),
      newProdSeries: document.getElementById("newProdSeries"),
      newProdImages: document.getElementById("newProdImages"),
      newProdPreviewList: document.getElementById("newProdPreviewList"),
      addProductBtn: document.getElementById("addProductBtn"),
      updateProductBtn: document.getElementById("updateProductBtn"),

      discountRate: document.getElementById("discountRate"),
      depositRate: document.getElementById("depositRate"),
      saveDiscountBtn: document.getElementById("saveDiscountBtn"),

      invoiceModal: document.getElementById("invoiceModal"),
      invoiceBody: document.getElementById("invoiceBody"),
      printInvoiceBtn: document.getElementById("printInvoiceBtn"),
      downloadPdfBtn: document.getElementById("downloadPdfBtn"),

      // filters admin elements
      filtersStages: document.getElementById("filtersStages"),
      filtersGrades: document.getElementById("filtersGrades"),
      filtersSubjects: document.getElementById("filtersSubjects"),
      filtersSeries: document.getElementById("filtersSeries"),
      newStage: document.getElementById("newStage"),
      newGrade: document.getElementById("newGrade"),
      newSubject: document.getElementById("newSubject"),
      newSeries: document.getElementById("newSeries"),
      addStageBtn: document.getElementById("addStageBtn"),
      addGradeBtn: document.getElementById("addGradeBtn"),
      addSubjectBtn: document.getElementById("addSubjectBtn"),
      addSeriesBtn: document.getElementById("addSeriesBtn")
    };

    /* ---------- UTILITIES ---------- */
    function showToast(msg, type = "info") {
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;bottom:18px;left:18px;padding:10px 14px;border-radius:8px;color:#fff;z-index:99999";
      el.style.background = type === "error" ? "#e74c3c" : (type === "success" ? "#27ae60" : "#3498db");
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }
    
    function formatCurrency(n) { 
      return `${Number(n).toFixed(2)} ج.م`; 
    }

    // helper convert file -> base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /* ---------- DEBOUNCE helper ---------- */
    function debounce(fn, wait) {
      let t;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    /* ---------- TRANSLATION APPLY ---------- */
    function applyTranslations() {
      const t = T[currentLang];

      // Main titles
      if (refs.mainTitle) refs.mainTitle.textContent = t.mainTitle;
      if (refs.filterTitle) refs.filterTitle.textContent = t.filterTitle;
      if (refs.searchInput) refs.searchInput.placeholder = t.searchPlaceholder;

      // Filter labels
      if (document.getElementById("stageLbl")) document.getElementById("stageLbl").textContent = t.stageLbl;
      if (document.getElementById("gradeLbl")) document.getElementById("gradeLbl").textContent = t.gradeLbl;
      if (document.getElementById("subjectLbl")) document.getElementById("subjectLbl").textContent = t.subjectLbl;
      if (document.getElementById("seriesLbl")) document.getElementById("seriesLbl").textContent = t.seriesLbl;

      // Tabs (Books / Stationery)
      if (refs.tabBooks) refs.tabBooks.textContent = t.booksTab;
      if (refs.tabStationery) refs.tabStationery.textContent = t.stationeryTab;

      // Cart section
      if (refs.cartTitle) refs.cartTitle.textContent = t.cartTitle;
      if (document.getElementById("lblSubtotalBooks")) document.getElementById("lblSubtotalBooks").textContent = t.subtotalBooks;
      if (document.getElementById("lblSubtotalStationery")) document.getElementById("lblSubtotalStationery").textContent = t.subtotalStationery;
      if (document.getElementById("lblSubtotalAll")) document.getElementById("lblSubtotalAll").textContent = t.subtotalAll;
      if (document.getElementById("lblTotalDiscount")) document.getElementById("lblTotalDiscount").textContent = t.totalDiscount;
      if (document.getElementById("lblDepositAmount")) document.getElementById("lblDepositAmount").textContent = t.depositAmount;
      if (document.getElementById("lblGrandTotal")) document.getElementById("lblGrandTotal").textContent = t.grandTotal;
      if (document.getElementById("lblRemainAmount")) document.getElementById("lblRemainAmount").textContent = t.remainAmount;

      if (refs.btnInvoice) refs.btnInvoice.textContent = t.invoice;
      if (refs.btnClear) refs.btnClear.textContent = t.clearCart;

      // Login + Settings
      if (document.getElementById("loginTitle")) document.getElementById("loginTitle").textContent = t.loginTitle;
      if (document.getElementById("settingsTitle")) document.getElementById("settingsTitle").textContent = t.settingsTitle;

      // Settings Tabs (Products / Filters / Discount)
      const settingsTabs = document.querySelectorAll(".settings-tab");
      if (settingsTabs[0]) settingsTabs[0].textContent = t.productsTab;
      if (settingsTabs[1]) settingsTabs[1].textContent = t.discountTab;

      // Discount labels
      if (refs.saveDiscountBtn) refs.saveDiscountBtn.textContent = t.saveDiscount;

      // Invoice section
      if (document.getElementById("invoiceTitle")) document.getElementById("invoiceTitle").textContent = t.invoiceTitle;
      if (refs.printInvoiceBtn) refs.printInvoiceBtn.textContent = t.print;
      if (refs.downloadPdfBtn) refs.downloadPdfBtn.innerHTML = `<i class="fas fa-file-pdf"></i> ${t.pdf}`;

      // Customer form (labels + placeholders)
      if (document.querySelector("label[for='custName']")) document.querySelector("label[for='custName']").textContent = t.parentName;
      if (document.querySelector("label[for='custPhone']")) document.querySelector("label[for='custPhone']").textContent = t.phone;
      if (document.querySelector("label[for='custAddress']")) document.querySelector("label[for='custAddress']").textContent = t.address;
      if (document.querySelector("label[for='paymentMethod']")) document.querySelector("label[for='paymentMethod']").textContent = t.payment;

      if (refs.custName) refs.custName.placeholder = t.enterName;
      if (refs.custPhone) refs.custPhone.placeholder = t.phoneEx;
      if (refs.custAddress) refs.custAddress.placeholder = t.addressEx;

      // Payment options
      const paySel = document.getElementById("paymentMethod");
      if (paySel) {
        const instapayOpt = paySel.querySelector("option[value='instapay']");
        const codOpt = paySel.querySelector("option[value='cod']");
        if (instapayOpt) instapayOpt.textContent = t.paymentInstapay;
        if (codOpt) codOpt.textContent = t.paymentCOD;
      }
    }

    /* ---------- Language toggle ---------- */
    refs.langToggle.addEventListener("click", () => {
      currentLang = currentLang === "ar" ? "en" : "ar";
      applyTranslations();
    });

    /* First call */
    applyTranslations();

    /* ---------- POPULATE FILTER SELECTS ---------- */
    function populateFilterSelects() {
      function fill(selectEl, arr) {
        if (!selectEl) return;
        const allText = currentLang === "ar" ? "الكل" : "All";
        selectEl.innerHTML = `<option value="">${allText}</option>` + arr.map(v => `<option value="${v}">${v}</option>`).join("");
      }
      fill(refs.stageSelect, filters.stages);
      fill(refs.gradeSelect, filters.grades);
      fill(refs.subjectSelect, filters.subjects);
      fill(refs.seriesSelect, filters.series);
    }
    /* ---------- RENDER PRODUCTS (with + / - buttons) ---------- */
    function renderProducts() {
      const booksGrid = document.getElementById("booksGrid");
      const stationeryGrid = document.getElementById("stationeryGrid");
      
      if (!booksGrid || !stationeryGrid) {
        console.error("عناصر الشبكة غير موجودة في DOM");
        return;
      }
      
      booksGrid.innerHTML = "";
      stationeryGrid.innerHTML = "";

      const search = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      const stage = document.getElementById("stageSelect").value;
      const grade = document.getElementById("gradeSelect").value;
      const subject = document.getElementById("subjectSelect").value;
      const seriesSel = document.getElementById("seriesSelect").value;

      products.forEach(p => {
        if (search && !p.name.toLowerCase().includes(search)) return;
        if (p.type === "book") {
          if ((stage && p.stage !== stage) || (grade && p.grade !== grade) || 
              (subject && p.subject !== subject) || (seriesSel && p.series !== seriesSel)) return;
        }

        const card = document.createElement("div");
        card.className = "product-card";
        
        // استخدام الصورة الأولى إذا كانت متاحة
        const imgSrc = (p.images && p.images.length > 0) ? p.images[0] : "https://via.placeholder.com/300x200?text=No+Image";
        
        card.innerHTML = `
          <img class="product-image" src="${imgSrc}" alt="${p.name}">
          <div style="margin-top:8px;font-weight:800">${p.name}</div>
          <div class="product-meta" style="font-size:13px;color:#666;margin-top:6px">
            ${p.type === "book" ? `${p.stage || ""} ${p.grade ? " | " + p.grade : ""} ${p.subject ? " | " + p.subject : ""}` : (p.category || "")}
          </div>
          <div class="product-footer">
            <div style="font-weight:800">${formatCurrency(p.price)}</div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-outline btn-decrease" data-id="${p.id}">-</button>
              <button class="btn btn-primary btn-increase" data-id="${p.id}">+</button>
            </div>
          </div>
        `;

        // إضافة مستمعي الأحداث للأزرار
        card.querySelector(".btn-increase").addEventListener("click", (e) => { 
          e.stopPropagation();
          addToCart(p.id); 
        });
        
        card.querySelector(".btn-decrease").addEventListener("click", (e) => { 
          e.stopPropagation();
          decreaseCartQty(p.id); 
        });

        // إضافة مستمع للنقر على البطاقة لعرض التفاصيل
        card.addEventListener("click", () => {
          showProductDetails(p);
        });

        if (p.type === "book") {
          booksGrid.appendChild(card);
        } else {
          stationeryGrid.appendChild(card);
        }
      });
    }

    /* ---------- CART FUNCTIONS & CALCULATIONS ---------- */
    function addToCart(id) {
      const prod = products.find(x => x.id === id);
      if (!prod) return;
      const it = cart.find(c => c.id === id);
      if (it) it.qty += 1; else cart.push({ ...prod, qty: 1 });
      renderCart();
    }
    
    function decreaseCartQty(id) {
      const it = cart.find(c => c.id === id);
      if (!it) return;
      it.qty -= 1;
      if (it.qty <= 0) cart = cart.filter(c => c.id !== id);
      renderCart();
    }
    
    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      renderCart();
    }

   function renderCart() {
  const cartItems = document.getElementById("cartItems");
  if (!cartItems) return;

  cartItems.innerHTML = "";
  let booksTotal = 0, stationeryTotal = 0;

  cart.forEach(item => {
    const row = document.createElement("div");
    row.className = "cart-item";
    row.innerHTML = `
      <div style="max-width:60%"><strong>${item.name}</strong>
        <div style="color:#666;font-size:13px">${item.qty} × ${formatCurrency(item.price)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div style="font-weight:800">${formatCurrency(item.qty * item.price)}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-outline small-dec" data-id="${item.id}">-</button>
          <button class="btn btn-outline small-inc" data-id="${item.id}">+</button>
          <button class="btn btn-outline" data-del="${item.id}"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    cartItems.appendChild(row);

    row.querySelector(".small-inc").addEventListener("click", () => { addToCart(item.id); });
    row.querySelector(".small-dec").addEventListener("click", () => { decreaseCartQty(item.id); });
    row.querySelector("[data-del]").addEventListener("click", () => { removeFromCart(item.id); });

    if (item.type === "book") booksTotal += item.qty * item.price;
    else stationeryTotal += item.qty * item.price;
  });

  // --- الحسابات ---
  const subtotal = booksTotal + stationeryTotal;
  const discountRate = parseFloat(discountSettings.discountRate) || 0;
  const depositRate = parseFloat(discountSettings.depositRate) || 0;

  const discountValue = subtotal > 0 ? subtotal * (discountRate / 100) : 0;
  const afterDiscount = Math.max(0, subtotal - discountValue);
  const deposit = afterDiscount * (depositRate / 100);
  const remain = Math.max(0, afterDiscount - deposit);

  // --- تحديث الواجهة ---
  document.getElementById("subtotalBooks").textContent = formatCurrency(booksTotal);
  document.getElementById("subtotalStationery").textContent = formatCurrency(stationeryTotal);
  document.getElementById("subtotalAll").textContent = formatCurrency(subtotal);
  document.getElementById("totalDiscount").textContent = formatCurrency(discountValue);
  document.getElementById("depositAmount").textContent = formatCurrency(deposit);
  document.getElementById("grandTotal").textContent = formatCurrency(afterDiscount);
  document.getElementById("remainAmount").textContent = formatCurrency(remain);

  const btnInvoice = document.getElementById("btnInvoice");
  if (btnInvoice) btnInvoice.disabled = cart.length === 0;
}


    /* ---------- TAB NAVIGATION (Books / Stationery) ---------- */
    refs.tabBooks.addEventListener("click", () => {
      refs.tabBooks.classList.add("active");
      refs.tabStationery.classList.remove("active");
      refs.booksGrid.style.display = "grid";
      refs.stationeryGrid.style.display = "none";
    });
    
    refs.tabStationery.addEventListener("click", () => {
      refs.tabStationery.classList.add("active");
      refs.tabBooks.classList.remove("active");
      refs.stationeryGrid.style.display = "grid";
      refs.booksGrid.style.display = "none";
    });

    /* ---------- SEARCH / FILTER LISTENERS ---------- */
    [refs.searchInput, refs.stageSelect, refs.gradeSelect, refs.subjectSelect, refs.seriesSelect].forEach(el => {
      if (!el) return;
      el.addEventListener("input", debounce(renderProducts, 180));
      el.addEventListener("change", renderProducts);
    });

    /* ---------- LOGIN & SETTINGS ---------- */
    refs.btnClear.addEventListener("click", () => {
      if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
      if (!confirm(T[currentLang].confirmClearCart)) return;
      cart = [];
      renderCart();
    });

    refs.btnInvoice.addEventListener("click", () => { openInvoiceModal(); });

    refs.btnInvoice.disabled = true; // initially

    document.getElementById("btnSettings").addEventListener("click", () => {
      refs.adminEmail.value = "";
      refs.adminPassword.value = "";
      refs.loginModal.classList.add("show");
    });

    refs.loginSubmit.addEventListener("click", () => {
      const e = (refs.adminEmail.value || "").trim();
      const p = (refs.adminPassword.value || "").trim();
   firebase.auth().signInWithEmailAndPassword(e, p)
  .then(userCred => {
    refs.loginModal.classList.remove("show");
    refs.settingsModal.classList.add("show");
    onSettingsOpen();
  })
  .catch(err => {
    showToast(T[currentLang].loginWrong, "error");
    console.error(err);
  });

    });

    refs.settingsTabs.forEach(btn => {
      btn.addEventListener("click", () => {
        refs.settingsTabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        refs.settingsPanels.forEach(p => p.classList.remove("active"));
        const target = btn.dataset.tab;
        const panel = document.getElementById(target);
        if (panel) panel.classList.add("active");
      });
    });

    document.querySelectorAll(".modal .close").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const modal = btn.closest(".modal");
        if (modal) modal.classList.remove("show");
      });
    });

    /* ---------- ADMIN: Products management (add / edit / delete + image upload) ---------- */

    // =============================
    // Render Admin List
    // =============================
    function renderProductsAdmin() {
      const productsList = document.getElementById("productsList");
      if (!productsList) return;
      
      productsList.innerHTML = "";

      products.forEach(p => {
        const item = document.createElement("div");
        item.style.cssText = "padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center";
        
        item.innerHTML = `
          <div>
            <strong>${p.name}</strong> - ${formatCurrency(p.price)}
            <div style="font-size:12px;color:#666">${p.type === 'book' ? 'كتاب' : 'أداة مكتبية'}</div>
          </div>
          <div>
            <button class="btn btn-outline" data-edit="${p.id}">تعديل</button>
            <button class="btn btn-danger" data-delete="${p.id}">حذف</button>
          </div>
        `;
        
        productsList.appendChild(item);

        item.querySelector(`[data-edit="${p.id}"]`).addEventListener("click", () => {
          startEditProduct(p.id);
        });
        
        item.querySelector(`[data-delete="${p.id}"]`).addEventListener("click", () => {
          if (confirm("هل تريد حذف هذا المنتج؟")) {
            products = products.filter(prod => prod.id !== p.id);
            saveAll();
            renderProductsAdmin();
            showToast(T[currentLang].productRemoved, "success");
          }
        });
      });
    }

    // =============================
    // Start Editing Product
    // =============================
    function startEditProduct(id) {
      const p = products.find(x => x.id === id); 
      if (!p) return;

      editingProductId = id;
      refs.newProdName.value = p.name || "";
      refs.newProdType.value = p.type || "book";
      refs.newProdPrice.value = p.price || 0;

      if (p.type === "book") {
        refs.newProdSeries.value = p.series || "";
      } else if (p.type === "stationery") {
        refs.newProdSeries.value = p.category || "";
      } else {
        refs.newProdSeries.value = "";
      }

      refs.newProdPreviewList.innerHTML = "";
      if (p.images && p.images.length) {
        p.images.forEach(imgSrc => {
          const img = document.createElement("img");
          img.src = imgSrc;
          img.classList.add("preview-thumb");
          refs.newProdPreviewList.appendChild(img);
        });
      }

      refs.settingsModal.classList.add("show");
    }

    // =============================
    // Preview new images immediately
    // =============================
    refs.newProdImages.addEventListener("change", (e) => {
      refs.newProdPreviewList.innerHTML = "";
      const files = e.target.files;
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement("img");
          img.src = reader.result;
          img.classList.add("preview-thumb");
          refs.newProdPreviewList.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // =============================
    // Product Details Modal
    // =============================
    function showProductDetails(product) {
      const container = document.getElementById("productDetails");
      container.innerHTML = `
        <h2>${product.name}</h2>
        <div class="product-details-images">
          ${(product.images || []).map(img => `<img src="${img}">`).join("")}
        </div>
        <div class="product-info">
          <p><strong>السعر:</strong> ${formatCurrency(product.price)}</p>
          ${product.type === "book" ? `
            <p><strong>المرحلة:</strong> ${product.stage || ""}</p>
            <p><strong>الصف:</strong> ${product.grade || ""}</p>
            <p><strong>المادة:</strong> ${product.subject || ""}</p>
            <p><strong>السلسلة:</strong> ${product.series || ""}</p>
          ` : `
            <p><strong>التصنيف:</strong> ${product.category || ""}</p>
          `}
        </div>
      `;
      document.getElementById("productModal").classList.add("show");
    }

    document.getElementById("closeProductModal").addEventListener("click", () => {
      document.getElementById("productModal").classList.remove("show");
    });

    // =============================
    // Add Product
    // =============================
    refs.addProductBtn.addEventListener("click", async () => {
      const name = (refs.newProdName.value || "").trim();
      const type = refs.newProdType.value;
      const price = parseFloat(refs.newProdPrice.value) || 0;
      const seriesOrCat = (refs.newProdSeries.value || "").trim();

      if (!name) { showToast(T[currentLang].enterProdName, "error"); return; }

      let imagesData = [];
      if (refs.newProdImages.files.length > 0) {
        imagesData = await Promise.all(Array.from(refs.newProdImages.files).map(file => fileToBase64(file)));
      }

      const id = Date.now().toString();
      const item = type === "book"
        ? { id, type: "book", name, price, stage: filters.stages[0] || "", grade: filters.grades[0] || "", subject: filters.subjects[0] || "", series: seriesOrCat, images: imagesData }
        : { id, type: "stationery", name, price, category: seriesOrCat, images: imagesData };

      products.push(item);
      saveAll();
      renderProducts();      
      renderProductsAdmin();

      refs.newProdName.value = "";
      refs.newProdPrice.value = "";
      refs.newProdSeries.value = "";
      refs.newProdImages.value = "";
      refs.newProdPreviewList.innerHTML = "";
      showToast(T[currentLang].productAdded, "success");
    });

    // =============================
    // Update Product
    // =============================
    refs.updateProductBtn.addEventListener("click", async () => {
      if (!editingProductId) { showToast(T[currentLang].noEdit, "error"); return; }
      const p = products.find(x => x.id === editingProductId); 
      if (!p) return;

      p.name = (refs.newProdName.value || "").trim();
      p.type = refs.newProdType.value;
      p.price = parseFloat(refs.newProdPrice.value) || 0;

      if (p.type === "book") {
        p.series = (refs.newProdSeries.value || "").trim();
      } else if (p.type === "stationery") {
        p.category = (refs.newProdSeries.value || "").trim();
      }

      if (refs.newProdImages.files.length > 0) {
        p.images = await Promise.all(Array.from(refs.newProdImages.files).map(file => fileToBase64(file)));
      }

      saveAll();
      renderProducts(); 
      renderProductsAdmin();

      editingProductId = null;
      refs.newProdName.value = "";
      refs.newProdPrice.value = "";
      refs.newProdSeries.value = "";
      refs.newProdImages.value = "";
      refs.newProdPreviewList.innerHTML = "";
      showToast(T[currentLang].productUpdated, "success");
    });

    /* ---------- ADMIN: Filters management (add / delete) ---------- */
    function renderFiltersAdmin() {
      function renderList(containerEl, arr, type) {
        containerEl.innerHTML = "";
        arr.forEach((item, i) => {
          const div = document.createElement("div");
          div.style = "display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px";
          div.innerHTML = `<span>${item}</span><button class="btn btn-outline" data-del="${type}-${i}"><i class="fas fa-trash"></i></button>`;
          containerEl.appendChild(div);
          div.querySelector("[data-del]").addEventListener("click", () => {
            filters[type].splice(i, 1);
            saveAll();
            renderFiltersAdmin();
            populateFilterSelects();
            showToast(T[currentLang].filtersSaved, "success");
          });
        });
      }
      renderList(refs.filtersStages, filters.stages, "stages");
      renderList(refs.filtersGrades, filters.grades, "grades");
      renderList(refs.filtersSubjects, filters.subjects, "subjects");
      renderList(refs.filtersSeries, filters.series, "series");
    }

    refs.addStageBtn.addEventListener("click", () => {
      const val = (refs.newStage.value || "").trim();
      if (!val) return;
      if (!filters.stages.includes(val)) filters.stages.push(val);
      refs.newStage.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addGradeBtn.addEventListener("click", () => {
      const val = (refs.newGrade.value || "").trim();
      if (!val) return;
      if (!filters.grades.includes(val)) filters.grades.push(val);
      refs.newGrade.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addSubjectBtn.addEventListener("click", () => {
      const val = (refs.newSubject.value || "").trim();
      if (!val) return;
      if (!filters.subjects.includes(val)) filters.subjects.push(val);
      refs.newSubject.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addSeriesBtn.addEventListener("click", () => {
      const val = (refs.newSeries.value || "").trim();
      if (!val) return;
      if (!filters.series.includes(val)) filters.series.push(val);
      refs.newSeries.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });

    /* ---------- ADMIN: Discount save ---------- */
    refs.saveDiscountBtn.addEventListener("click", () => {
      discountSettings.discountRate = parseFloat(refs.discountRate.value) || 0;
      discountSettings.depositRate = parseFloat(refs.depositRate.value) || 0;
      saveAll();
      renderCart();
      showToast(T[currentLang].saveDiscount, "success");
    });

    /* ---------- INVOICE / PDF ---------- */
    function openInvoiceModal() {
      if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
      let html = `<p><strong>${T[currentLang].invoiceTitle}</strong></p>`;
      html += `<p><strong>${T[currentLang].parentName || "Client"}:</strong> ${refs.custName.value || "-" }<br>`;
      html += `<strong>${T[currentLang].phone || "Phone"}:</strong> ${refs.custPhone.value || "-" }<br>`;
      html += `<strong>${T[currentLang].address || "Address"}:</strong> ${refs.custAddress.value || "-" }</p>`;
      html += `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f0f0f0"><th style="padding:6px;border:1px solid #eee">المنتج</th><th style="padding:6px;border:1px solid #eee">الكمية</th><th style="padding:6px;border:1px solid #eee">السعر</th><th style="padding:6px;border:1px solid #eee">الإجمالي</th></tr></thead><tbody>`;
      cart.forEach(i => {
        html += `<tr><td style="padding:6px;border:1px solid #eee">${i.name}</td><td style="padding:6px;border:1px solid #eee">${i.qty}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.price)}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.qty * i.price)}</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<p><strong>${T[currentLang].subtotalAll}</strong> ${refs.subtotalAll.textContent}<br>`;
      html += `<strong>${T[currentLang].totalDiscount}</strong> ${refs.totalDiscount.textContent}<br>`;
      html += `<strong>${T[currentLang].grandTotal}</strong> ${refs.grandTotal.textContent}<br>`;
      html += `<strong>${T[currentLang].depositAmount}</strong> ${refs.depositAmount.textContent}<br>`;
      html += `<strong>${T[currentLang].remainAmount}</strong> ${refs.remainAmount.textContent}</p>`;

      refs.invoiceBody.innerHTML = html;
      refs.invoiceModal.classList.add("show");
    }
    
    refs.printInvoiceBtn.addEventListener("click", () => window.print());
    
    refs.downloadPdfBtn.addEventListener("click", () => {
  const pdf = new jspdf.jsPDF("p", "pt", "a4");
  pdf.html(refs.invoiceBody, {
    callback: function (pdf) {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      if (isMobile) {
        // افتح الفاتورة في نافذة جديدة للموبايل
        const pdfUrl = pdf.output("bloburl");
        window.open(pdfUrl, "_blank");
      } else {
        // تنزيل مباشر للكمبيوتر
        const pdfBlob = pdf.output("blob");
        const link = document.createElement("a");
        link.href = URL.createObjectURL(pdfBlob);
        link.download = "invoice.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }
    }
  });
});

    /* ---------- SETTINGS OPEN initial sync ---------- */
    function onSettingsOpen() {
      renderProductsAdmin();
      refs.discountRate.value = discountSettings.discountRate;
      refs.depositRate.value = discountSettings.depositRate;
      renderFiltersAdmin();
    }

    /* ---------- INITIALIZATION ---------- */
    async function init() {
      applyTranslations();
      populateFilterSelects();
      
      try {
        // تحميل البيانات من Firebase
        await loadDataFromFirebase();
        console.log("تم التحميل من Firebase");
      } catch (error) {
        console.error("خطأ في التحميل من Firebase:", error);
        // في حالة الخطأ، نستخدم البيانات المحلية
        loadFromLocalStorage();
        console.log("تم التحميل من التخزين المحلي");
        showToast("يعمل في الوضع غير المتصل", "info");
      }
      
      renderProducts();
      renderCart();
      
      // إعداد مستمعي الأحداث
      document.querySelectorAll(".modal .close").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const modal = btn.closest(".modal");
          if (modal) modal.classList.remove("show");
        });
      });
      
      // إعداد مستمعي البحث والتصفية
      const searchInput = document.getElementById("searchInput");
      const stageSelect = document.getElementById("stageSelect");
      const gradeSelect = document.getElementById("gradeSelect");
      const subjectSelect = document.getElementById("subjectSelect");
      const seriesSelect = document.getElementById("seriesSelect");
      
      if (searchInput) searchInput.addEventListener("input", debounce(renderProducts, 300));
      if (stageSelect) stageSelect.addEventListener("change", renderProducts);
      if (gradeSelect) gradeSelect.addEventListener("change", renderProducts);
      if (subjectSelect) subjectSelect.addEventListener("change", renderProducts);
      if (seriesSelect) seriesSelect.addEventListener("change", renderProducts);
      
      // إعداد تبويبات الكتب والأدوات المكتبية
      const tabBooks = document.getElementById("tabBooks");
      const tabStationery = document.getElementById("tabStationery");
      
      if (tabBooks && tabStationery) {
        tabBooks.addEventListener("click", () => {
          tabBooks.classList.add("active");
          tabStationery.classList.remove("active");
          document.getElementById("booksGrid").style.display = "grid";
          document.getElementById("stationeryGrid").style.display = "none";
        });
        
        tabStationery.addEventListener("click", () => {
          tabStationery.classList.add("active");
          tabBooks.classList.remove("active");
          document.getElementById("stationeryGrid").style.display = "grid";
          document.getElementById("booksGrid").style.display = "none";
        });
      }
    }

    // بدء التهيئة
    init();

    /* ---------- نهاية السكربت ---------- */
  </script>
</body>
</html>
