<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø¸Ø§Ù… XY Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Ø¥Ø¶Ø§ÙØ© Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <style>
    /* Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙˆØ¯ ÙˆØ§Ù„Ø°Ù‡Ø¨ÙŠ */
    :root {
      --gold: #D4AF37;
      --dark-gold: #B8860B;
      --black: #000000;
      --dark-gray: #1a1a1a;
      --light-gray: #333333;
      --text-light: #cccccc;
      --white: #ffffff;
    }
    
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      background: var(--black);
      color: var(--text-light);
      direction: rtl;
    }
    
    header {
      background: linear-gradient(to right, var(--black), var(--dark-gray));
      color: var(--gold);
      padding: 12px 16px;
      border-bottom: 2px solid var(--gold);
      text-align: center;
      box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      border: 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-primary:hover {
      background: var(--dark-gold);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);
    }
    
    .btn-accent {
      background: var(--dark-gray);
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    
    .btn-accent:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
    }
    
    .btn-outline:hover {
      background: var(--gold);
      color: var(--black);
    }
    
    .btn-danger {
      background: #8B0000;
      color: var(--white);
    }
    
    .btn-danger:hover {
      background: #A52A2A;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      padding: 14px;
    }
    
    .panel {
      background: var(--dark-gray);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--light-gray);
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin: 8px 0;
    }
    
    .filter-input, .filter-select {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }
    
    .tabs {
      display: flex;
      gap: 6px;
      margin: 8px 0;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .product-card {
      border: 1px solid var(--light-gray);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      background: var(--black);
      transition: all 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
      border-color: var(--gold);
    }
    
    .product-image {
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--dark-gray);
    }
    
    .preview-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--light-gray);
      margin: 4px 2px;
    }

    .preview-container {
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 4px 0;
    }

    .preview-container::-webkit-scrollbar {
      height: 6px;
    }

    .preview-container::-webkit-scrollbar-thumb {
      background-color: var(--gold);
      border-radius: 3px;
    }

    .preview-container img.preview-thumb {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--light-gray);
      flex-shrink: 0;
    }
    
    .product-details-images {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px 0;
    }
    
    .product-details-images img {
      height: 150px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid #444;
    }
    
    .product-info {
      margin-top: 10px;
    }
    
    .product-info h3 {
      color: var(--gold);
      margin-bottom: 8px;
    }

    .product-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--light-gray);
    }
    
    .sidebar .summary-item {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      padding: 4px 0;
      border-bottom: 1px dashed var(--light-gray);
    }
    
    .cart-items {
      max-height: 220px;
      overflow: auto;
      margin: 10px 0;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--dark-gray);
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      border: 2px solid var(--gold);
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }
    
    .close {
      position: absolute;
      top: 10px;
      left: 10px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 22px;
      color: var(--gold);
    }
    
    .settings-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 15px;
    }
    
    .settings-tab {
      flex: 1;
      padding: 10px;
      border: 0;
      cursor: pointer;
      border-radius: 6px;
      background: var(--black);
      color: var(--text-light);
    }
    
    .settings-tab.active {
      background: var(--gold);
      color: var(--black);
      font-weight: bold;
    }
    
    .settings-panel {
      display: none;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .xy-thumb {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      margin-top: 4px;
      border: 1px solid var(--light-gray);
    }
    
    h2, h3, h4 {
      color: var(--gold);
      margin: 12px 0;
    }
    
    label {
      color: var(--text-light);
      margin-bottom: 5px;
      display: block;
    }
    
    /* Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø°Ù‡Ø¨ÙŠ */
    #subtotalBooks, #subtotalStationery, #subtotalAll,
    #totalDiscount, #depositAmount, #grandTotal, #remainAmount,
    .product-footer div:first-child {
      color: var(--gold);
      font-weight: bold;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
    .panel-header {
      border-bottom: 1px solid var(--gold);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="mainTitle"><i class="fas fa-book"></i> Ù†Ø¸Ø§Ù… XY</h1>
    <div>
      <button id="langToggle" class="btn btn-outline">English</button>
      <button id="btnSettings" class="btn btn-primary"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>
  </header>

  <div class="container">
    <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="panel">
      <h3 id="filterTitle">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h3>
      <input id="searchInput" class="filter-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...">
      <div class="filter-row">
        <div class="filter-group book-only">
          <label id="stageLbl">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <select id="stageSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="gradeLbl">Ø§Ù„ØµÙ</label>
          <select id="gradeSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="subjectLbl">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
          <select id="subjectSelect" class="filter-select"></select>
        </div>
        <div class="filter-group book-only">
          <label id="seriesLbl">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</label>
          <select id="seriesSelect" class="filter-select"></select>
        </div>
      </div>
      <div class="tabs">
        <button id="tabBooks" class="tab active">ÙƒØªØ¨ Ø®Ø§Ø±Ø¬ÙŠØ©</button>
        <button id="tabStationery" class="tab">Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©</button>
      </div>
      <div id="booksGrid" class="products-grid"></div>
      <div id="stationeryGrid" class="products-grid" style="display:none"></div>
    </div>

    <!-- Ø§Ù„Ø³Ù„Ø© -->
   <aside class="sidebar panel">
      <h3 id="cartTitle">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>

      <div class="panel" style="margin-bottom:10px">
        <label for="custName">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
        <input id="custName" class="filter-input">
        <label for="custPhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="custPhone" class="filter-input">
        <label for="custAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="custAddress" class="filter-input">
        <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="paymentMethod" class="filter-input">
          <option value="instapay">Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</option>
          <option value="cod">Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
        </select>
      </div>
      <div id="cartItems" class="cart-items"></div>
      <div class="summary">
        <div class="summary-item"><span id="lblSubtotalBooks">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨:</span><span id="subtotalBooks">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblSubtotalStationery">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Øª:</span><span id="subtotalStationery">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblSubtotalAll">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:</span><span id="subtotalAll">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblTotalDiscount">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…:</span><span id="totalDiscount">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblDepositAmount">Ø§Ù„Ù…Ù‚Ø¯Ù…:</span><span id="depositAmount">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblGrandTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span><span id="grandTotal">0 Ø¬.Ù…</span></div>
        <div class="summary-item"><span id="lblRemainAmount">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</span><span id="remainAmount">0 Ø¬.Ù…</span></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="btnInvoice" class="btn btn-primary" style="flex:1">ÙØ§ØªÙˆØ±Ø©</button>
        <button id="btnClear" class="btn btn-danger" style="flex:1">ØªÙØ±ÙŠØº</button>
      </div>
    </aside>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('loginModal').classList.remove('show')">&times;</button>
      <h3 id="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <input id="adminEmail" placeholder="Email" class="filter-input">
      <input id="adminPassword" type="password" placeholder="Password" class="filter-input">
      <button id="loginSubmit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('settingsModal').classList.remove('show')">&times;</button>
      <h3 id="settingsTitle">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="productsPanel">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        <button class="settings-tab" data-tab="discountPanel">Ø§Ù„Ø®ØµÙ…</button>
        <button class="settings-tab" data-tab="filtersPanel">Ø§Ù„ÙÙ„Ø§ØªØ±</button>
      </div>

      <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div id="productsPanel" class="settings-panel active">
        <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
        <div id="productsList"></div>
        <h4>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h4>
        <input id="newProdName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="filter-input">
        <select id="newProdType" class="filter-input">
          <option value="book">ÙƒØªØ§Ø¨</option>
          <option value="stationery">Ø£Ø¯Ø§Ø© Ù…ÙƒØªØ¨ÙŠØ©</option>
        </select>
          <input id="newProdPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="filter-input">

  <!-- ğŸ‘‡ Ø§Ø¶ÙØª Ø§Ù„Ø³ÙŠØ±ÙŠÙ€Ø² Ø£Ùˆ Ø§Ù„ØªØµÙ†ÙŠÙ -->
  <input id="newProdSeries" placeholder="Ø§Ù„Ø³Ù„Ø³Ù„Ø© / Ø§Ù„ØªØµÙ†ÙŠÙ" class="filter-input">

  <!-- Ø±ÙØ¹ Ø¹Ø¯Ø© ØµÙˆØ± -->
  <input id="newProdImages" type="file" accept="image/*" multiple class="filter-input">
  <div id="newProdPreviewList" class="preview-container"></div>

  <div style="margin-top:6px;display:flex;gap:6px">
    <button id="addProductBtn" class="btn btn-primary" style="flex:1">Ø¥Ø¶Ø§ÙØ©</button>
    <button id="updateProductBtn" class="btn btn-accent" style="flex:1">ØªØ­Ø¯ÙŠØ«</button>
  </div>
</div>

      <!-- Ø§Ù„Ø®ØµÙ… -->
      <div id="discountPanel" class="settings-panel">
        <h4>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®ØµÙ…</h4>
        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… %</label>
        <input id="discountRate" type="number" class="filter-input">
        <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù‚Ø¯Ù… %</label>
        <input id="depositRate" type="number" class="filter-input">
        <button id="saveDiscountBtn" class="btn btn-primary" style="margin-top:6px">Ø­ÙØ¸</button>
      </div>

      <!-- Ø§Ù„ÙÙ„Ø§ØªØ± -->
      <div id="filtersPanel" class="settings-panel">
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ„Ø§ØªØ±</h4>

        <div style="margin-top:8px">
          <label>Ø§Ù„Ù…Ø±Ø§Ø­Ù„</label>
          <div id="filtersStages"></div>
          <div class="small-field">
            <input id="newStage" class="filter-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©">
            <button id="addStageBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Ø§Ù„ØµÙÙˆÙ</label>
          <div id="filtersGrades"></div>
          <div class="small-field">
            <input id="newGrade" class="filter-input" placeholder="Ø£Ø¯Ø®Ù„ ØµÙ Ø¬Ø¯ÙŠØ¯">
            <button id="addGradeBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Ø§Ù„Ù…ÙˆØ§Ø¯</label>
          <div id="filtersSubjects"></div>
          <div class="small-field">
            <input id="newSubject" class="filter-input" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©">
            <button id="addSubjectBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Ø§Ù„Ø³Ù„Ø§Ø³Ù„</label>
          <div id="filtersSeries"></div>
          <div class="small-field">
            <input id="newSeries" class="filter-input" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ù„Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©">
            <button id="addSeriesBtn" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø³Ù„Ø³Ù„Ø©</button>
          </div>
        </div>

      </div>
    </div>
  </div>
  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <button class="close" onclick="document.getElementById('invoiceModal').classList.remove('show')">&times;</button>
      <h3 id="invoiceTitle">ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
      <div id="invoiceBody"></div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button id="printInvoiceBtn" class="btn btn-primary">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="downloadPdfBtn" class="btn btn-primary">ØªØ­Ù…ÙŠÙ„ PDF</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="productModal">
    <div class="modal-content">
      <button class="close" id="closeProductModal">&times;</button>
      <div id="productDetails"></div>
    </div>
  </div>

  <!-- Ø±ÙˆØ§Ø¨Ø· Ù„Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (ØªØ­Øª Ø¬Ø²Ø¡ Ø§Ù„Ù€ JS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    /* =========================
       ØªÙ‡ÙŠØ¦Ø© Firebase
       ========================= */
    const firebaseConfig = {
      apiKey: "AIzaSyDWsDR3WlS2JXi-Xp5Tp-70lioa5saroII",
      authDomain: "online-store-e2c20.firebaseapp.com",
      projectId: "online-store-e2c20",
      storageBucket: "online-store-e2c20.firebasestorage.app",
      messagingSenderId: "176583372373",
      appId: "1:176583372373:web:68594825749587b6446edc"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    /* =========================
       XY System - JavaScript Ù…Ø¹ Ø¯Ø¹Ù… Firebase
       ========================= */


    let currentLang = "ar";

    /* ---------- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Firebase) ---------- */
    let products = [];
    let filters = {
      stages: ["Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©", "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©", "Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©"],
      grades: ["Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«", "Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³"],
      subjects: ["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©"],
      series: ["Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­", "Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªÙ…ÙŠØ²", "Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªÙÙˆÙ‚"]
    };
    let discountSettings = { discountRate: 0, depositRate: 40 };
    let cart = [];
    let editingProductId = null;

    /* ---------- Ø¯ÙˆØ§Ù„ Firebase ---------- */
    async function loadDataFromFirebase() {
      try {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        const productsSnapshot = await db.collection("products").get();
        products = productsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ±
        const filtersDoc = await db.collection("settings").doc("filters").get();
        if (filtersDoc.exists) {
          filters = filtersDoc.data();
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ…
        const discountDoc = await db.collection("settings").doc("discount").get();
        if (discountDoc.exists) {
          discountSettings = discountDoc.data();
        }
        
        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ø­Ø¯Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderProducts();
        populateFilterSelects();
        renderCart();
        
        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase");
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        loadFromLocalStorage();
      }
    }

    async function saveAllToFirebase() {
      try {
        // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        const batch = db.batch();
        const productsRef = db.collection("products");
        
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        const snapshot = await productsRef.get();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        products.forEach(product => {
          // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ id Ù‡Ùˆ Ù†Øµ ÙˆÙ„ÙŠØ³ Ø±Ù‚Ù…
          const docRef = productsRef.doc(product.id.toString());
          
          // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø®Ø§ØµÙŠØ© id
          const { id, ...productData } = product;
          batch.set(docRef, productData);
        });
        
        await batch.commit();
        
        // Ø­ÙØ¸ Ø§Ù„ÙÙ„Ø§ØªØ±
        await db.collection("settings").doc("filters").set(filters);
        
        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ…
        await db.collection("settings").doc("discount").set(discountSettings);
        
        console.log("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase");
        showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "success");
        return true;
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase:", error);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©", "error");
        throw error;
      }
    }

    function setupRealtimeListeners() {
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      db.collection("products").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added" || change.type === "modified") {
            const productData = { id: change.doc.id, ...change.doc.data() };
            const index = products.findIndex(p => p.id == productData.id);
            
            if (index !== -1) {
              products[index] = productData;
            } else {
              products.push(productData);
            }
          } else if (change.type === "removed") {
            products = products.filter(p => p.id != change.doc.id);
          }
        });
        
        renderProducts();
      });

      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙ„Ø§ØªØ±
      db.collection("settings").doc("filters").onSnapshot(doc => {
        if (doc.exists) {
          filters = doc.data();
          populateFilterSelects();
        }
      });

      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ…
      db.collection("settings").doc("discount").onSnapshot(doc => {
        if (doc.exists) {
          discountSettings = doc.data();
          renderCart();
        }
      });
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ
    function saveToLocalStorage() {
      localStorage.setItem("xy_products_v2", JSON.stringify(products));
      localStorage.setItem("xy_filters_v2", JSON.stringify(filters));
      localStorage.setItem("xy_discount_v2", JSON.stringify(discountSettings));
    }

    function loadFromLocalStorage() {
      const savedProducts = JSON.parse(localStorage.getItem("xy_products_v2"));
      const savedFilters = JSON.parse(localStorage.getItem("xy_filters_v2"));
      const savedDiscount = JSON.parse(localStorage.getItem("xy_discount_v2"));
      
      if (savedProducts) products = savedProducts;
      if (savedFilters) filters = savedFilters;
      if (savedDiscount) discountSettings = savedDiscount;
      
      renderProducts();
      populateFilterSelects();
      renderCart();
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© saveAll Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase
    function saveAll() {
      // Ø­ÙØ¸ ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹
      saveAllToFirebase().then(() => {
        // Ø«Ù… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ§Ù‹
        saveToLocalStorage();
      }).catch(error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Firebase:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
        saveToLocalStorage();
      });
    }
    /* ---------- TRANSLATIONS ---------- */
    const T = {
      ar: {
        pageTitle: "Ù†Ø¸Ø§Ù… XY Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
        mainTitle: "Ù†Ø¸Ø§Ù… XY",
        langText: "English",
        filterTitle: "Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©",
        searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬...",
        stageLbl: "Ø§Ù„Ù…Ø±Ø­Ù„Ø©",
        gradeLbl: "Ø§Ù„ØµÙ",
        subjectLbl: "Ø§Ù„Ù…Ø§Ø¯Ø©",
        seriesLbl: "Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
        booksTab: "ÙƒØªØ¨ Ø®Ø§Ø±Ø¬ÙŠØ©",
        stationeryTab: "Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©",
        cartTitle: "Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª",
        parentName: "Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±",
        enterName: "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
        phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
        phoneEx: "Ù…Ø«Ø§Ù„: 20123456789",
        address: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
        addressEx: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø©",
        payment: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹",
        paymentInstapay: "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ",
        paymentCOD: "Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
        subtotalBooks: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨:",
        subtotalStationery: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Øª:",
        subtotalAll: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…:",
        totalDiscount: "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…:",
        depositAmount: "Ø§Ù„Ù…Ù‚Ø¯Ù…:",
        grandTotal: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:",
        remainAmount: "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:",
        invoice: "ÙØ§ØªÙˆØ±Ø©",
        export: "ØªØµØ¯ÙŠØ± CSV",
        clearCart: "ØªÙØ±ÙŠØº",
        loginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
        settingsTitle: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
        productsTab: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
        discountTab: "Ø§Ù„Ø®ØµÙ…",
        addProd: "Ø¥Ø¶Ø§ÙØ©",
        updateProd: "ØªØ­Ø¯ÙŠØ«",
        refreshProd: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶",
        saveDiscount: "Ø­ÙØ¸",
        loginWrong: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©",
        productAdded: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬",
        productUpdated: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬",
        productRemoved: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬",
        filtersSaved: "ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙÙ„Ø§ØªØ±",
        csvSaved: "ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV",
        invoiceTitle: "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨",
        print: "Ø·Ø¨Ø§Ø¹Ø©",
        pdf: "ØªØ­Ù…ÙŠÙ„ pdf",
        whatsapp: "Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨",
        cartEmpty: "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©",
        confirmClearCart: "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ",
        increase: "+",
        decrease: "-",
        deleted: "ØªÙ… Ø§Ù„Ø­Ø°Ù",
        enterPhone: "Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„",
        enterProdName: "Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬",
        noEdit: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© ØªØ¹Ø¯ÙŠÙ„",
      },
      en: {
        pageTitle: "XY Order System",
        mainTitle: "XY System",
        langText: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
        filterTitle: "Search & Filters",
        searchPlaceholder: "Search product name...",
        stageLbl: "Stage",
        gradeLbl: "Grade",
        subjectLbl: "Subject",
        seriesLbl: "Series",
        booksTab: "Books",
        stationeryTab: "Stationery",
        cartTitle: "Shopping Cart",
        parentName: "Parent Name",
        enterName: "Enter full name",
        phone: "Phone",
        phoneEx: "Example: 20123456789",
        address: "Address",
        addressEx: "City / Area",
        payment: "Payment Method",
        paymentInstapay: "Instapay",
        paymentCOD: "Cash on Delivery",
        subtotalBooks: "Books Total:",
        subtotalStationery: "Stationery Total:",
        subtotalAll: "Subtotal:",
        totalDiscount: "Discount:",
        depositAmount: "Deposit:",
        grandTotal: "Final Total:",
        remainAmount: "Remaining:",
        invoice: "Invoice",
        export: "Export CSV",
        clearCart: "Clear",
        loginTitle: "Login",
        settingsTitle: "Admin Settings",
        productsTab: "Products",
        discountTab: "Discount",
        addProd: "Add",
        updateProd: "Update",
        refreshProd: "Refresh",
        saveDiscount: "Save",
        loginWrong: "Credentials incorrect",
        productAdded: "Product added",
        productUpdated: "Product updated",
        productRemoved: "Product removed",
        filtersSaved: "Filters saved",
        csvSaved: "CSV downloaded",
        invoiceTitle: "Order Invoice",
        print: "Print",
        pdf: "download pdf",
        whatsapp: "Send WhatsApp",
        cartEmpty: "Cart is empty",
        confirmClearCart: "Clear cart?",
        increase: "+",
        decrease: "-",
        deleted: "Deleted",
        enterPhone: "Enter phone number",
        enterProdName: "Enter product name",
        noEdit: "No product selected",
      }
    };

    /* ---------- DOM refs ---------- */
    const refs = {
      langToggle: document.getElementById("langToggle"),
      mainTitle: document.getElementById("mainTitle"),
      filterTitle: document.getElementById("filterTitle"),
      searchInput: document.getElementById("searchInput"),
      stageSelect: document.getElementById("stageSelect"),
      gradeSelect: document.getElementById("gradeSelect"),
      subjectSelect: document.getElementById("subjectSelect"),
      seriesSelect: document.getElementById("seriesSelect"),
      tabBooks: document.getElementById("tabBooks"),
      tabStationery: document.getElementById("tabStationery"),
      booksGrid: document.getElementById("booksGrid"),
      stationeryGrid: document.getElementById("stationeryGrid"),

      cartTitle: document.getElementById("cartTitle"),
      custName: document.getElementById("custName"),
      custPhone: document.getElementById("custPhone"),
      custAddress: document.getElementById("custAddress"),
      cartItems: document.getElementById("cartItems"),
      subtotalBooks: document.getElementById("subtotalBooks"),
      subtotalStationery: document.getElementById("subtotalStationery"),
      subtotalAll: document.getElementById("subtotalAll"),
      totalDiscount: document.getElementById("totalDiscount"),
      depositAmount: document.getElementById("depositAmount"),
      grandTotal: document.getElementById("grandTotal"),
      remainAmount: document.getElementById("remainAmount"),

      btnInvoice: document.getElementById("btnInvoice"),
      btnClear: document.getElementById("btnClear"),

      loginModal: document.getElementById("loginModal"),
      loginSubmit: document.getElementById("loginSubmit"),
      adminEmail: document.getElementById("adminEmail"),
      adminPassword: document.getElementById("adminPassword"),

      settingsModal: document.getElementById("settingsModal"),
      settingsTabs: document.querySelectorAll(".settings-tab"),
      settingsPanels: document.querySelectorAll(".settings-panel"),
      productsList: document.getElementById("productsList"),
      newProdName: document.getElementById("newProdName"),
      newProdType: document.getElementById("newProdType"),
      newProdPrice: document.getElementById("newProdPrice"),
      newProdSeries: document.getElementById("newProdSeries"),
      newProdImages: document.getElementById("newProdImages"),
      newProdPreviewList: document.getElementById("newProdPreviewList"),
      addProductBtn: document.getElementById("addProductBtn"),
      updateProductBtn: document.getElementById("updateProductBtn"),

      discountRate: document.getElementById("discountRate"),
      depositRate: document.getElementById("depositRate"),
      saveDiscountBtn: document.getElementById("saveDiscountBtn"),

      invoiceModal: document.getElementById("invoiceModal"),
      invoiceBody: document.getElementById("invoiceBody"),
      printInvoiceBtn: document.getElementById("printInvoiceBtn"),
      downloadPdfBtn: document.getElementById("downloadPdfBtn"),

      // filters admin elements
      filtersStages: document.getElementById("filtersStages"),
      filtersGrades: document.getElementById("filtersGrades"),
      filtersSubjects: document.getElementById("filtersSubjects"),
      filtersSeries: document.getElementById("filtersSeries"),
      newStage: document.getElementById("newStage"),
      newGrade: document.getElementById("newGrade"),
      newSubject: document.getElementById("newSubject"),
      newSeries: document.getElementById("newSeries"),
      addStageBtn: document.getElementById("addStageBtn"),
      addGradeBtn: document.getElementById("addGradeBtn"),
      addSubjectBtn: document.getElementById("addSubjectBtn"),
      addSeriesBtn: document.getElementById("addSeriesBtn")
    };

    /* ---------- UTILITIES ---------- */
    function showToast(msg, type = "info") {
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;bottom:18px;left:18px;padding:10px 14px;border-radius:8px;color:#fff;z-index:99999";
      el.style.background = type === "error" ? "#e74c3c" : (type === "success" ? "#27ae60" : "#3498db");
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }
    
    function formatCurrency(n) { 
      return `${Number(n).toFixed(2)} Ø¬.Ù…`; 
    }

    // helper convert file -> base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /* ---------- DEBOUNCE helper ---------- */
    function debounce(fn, wait) {
      let t;
      return function (...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    /* ---------- TRANSLATION APPLY ---------- */
    function applyTranslations() {
      const t = T[currentLang];

      // Main titles
      if (refs.mainTitle) refs.mainTitle.textContent = t.mainTitle;
      if (refs.filterTitle) refs.filterTitle.textContent = t.filterTitle;
      if (refs.searchInput) refs.searchInput.placeholder = t.searchPlaceholder;

      // Filter labels
      if (document.getElementById("stageLbl")) document.getElementById("stageLbl").textContent = t.stageLbl;
      if (document.getElementById("gradeLbl")) document.getElementById("gradeLbl").textContent = t.gradeLbl;
      if (document.getElementById("subjectLbl")) document.getElementById("subjectLbl").textContent = t.subjectLbl;
      if (document.getElementById("seriesLbl")) document.getElementById("seriesLbl").textContent = t.seriesLbl;

      // Tabs (Books / Stationery)
      if (refs.tabBooks) refs.tabBooks.textContent = t.booksTab;
      if (refs.tabStationery) refs.tabStationery.textContent = t.stationeryTab;

      // Cart section
      if (refs.cartTitle) refs.cartTitle.textContent = t.cartTitle;
      if (document.getElementById("lblSubtotalBooks")) document.getElementById("lblSubtotalBooks").textContent = t.subtotalBooks;
      if (document.getElementById("lblSubtotalStationery")) document.getElementById("lblSubtotalStationery").textContent = t.subtotalStationery;
      if (document.getElementById("lblSubtotalAll")) document.getElementById("lblSubtotalAll").textContent = t.subtotalAll;
      if (document.getElementById("lblTotalDiscount")) document.getElementById("lblTotalDiscount").textContent = t.totalDiscount;
      if (document.getElementById("lblDepositAmount")) document.getElementById("lblDepositAmount").textContent = t.depositAmount;
      if (document.getElementById("lblGrandTotal")) document.getElementById("lblGrandTotal").textContent = t.grandTotal;
      if (document.getElementById("lblRemainAmount")) document.getElementById("lblRemainAmount").textContent = t.remainAmount;

      if (refs.btnInvoice) refs.btnInvoice.textContent = t.invoice;
      if (refs.btnClear) refs.btnClear.textContent = t.clearCart;

      // Login + Settings
      if (document.getElementById("loginTitle")) document.getElementById("loginTitle").textContent = t.loginTitle;
      if (document.getElementById("settingsTitle")) document.getElementById("settingsTitle").textContent = t.settingsTitle;

      // Settings Tabs (Products / Filters / Discount)
      const settingsTabs = document.querySelectorAll(".settings-tab");
      if (settingsTabs[0]) settingsTabs[0].textContent = t.productsTab;
      if (settingsTabs[1]) settingsTabs[1].textContent = t.discountTab;

      // Discount labels
      if (refs.saveDiscountBtn) refs.saveDiscountBtn.textContent = t.saveDiscount;

      // Invoice section
      if (document.getElementById("invoiceTitle")) document.getElementById("invoiceTitle").textContent = t.invoiceTitle;
      if (refs.printInvoiceBtn) refs.printInvoiceBtn.textContent = t.print;
      if (refs.downloadPdfBtn) refs.downloadPdfBtn.innerHTML = `<i class="fas fa-file-pdf"></i> ${t.pdf}`;

      // Customer form (labels + placeholders)
      if (document.querySelector("label[for='custName']")) document.querySelector("label[for='custName']").textContent = t.parentName;
      if (document.querySelector("label[for='custPhone']")) document.querySelector("label[for='custPhone']").textContent = t.phone;
      if (document.querySelector("label[for='custAddress']")) document.querySelector("label[for='custAddress']").textContent = t.address;
      if (document.querySelector("label[for='paymentMethod']")) document.querySelector("label[for='paymentMethod']").textContent = t.payment;

      if (refs.custName) refs.custName.placeholder = t.enterName;
      if (refs.custPhone) refs.custPhone.placeholder = t.phoneEx;
      if (refs.custAddress) refs.custAddress.placeholder = t.addressEx;

      // Payment options
      const paySel = document.getElementById("paymentMethod");
      if (paySel) {
        const instapayOpt = paySel.querySelector("option[value='instapay']");
        const codOpt = paySel.querySelector("option[value='cod']");
        if (instapayOpt) instapayOpt.textContent = t.paymentInstapay;
        if (codOpt) codOpt.textContent = t.paymentCOD;
      }
    }

    /* ---------- Language toggle ---------- */
    refs.langToggle.addEventListener("click", () => {
      currentLang = currentLang === "ar" ? "en" : "ar";
      applyTranslations();
    });

    /* First call */
    applyTranslations();

    /* ---------- POPULATE FILTER SELECTS ---------- */
    function populateFilterSelects() {
      function fill(selectEl, arr) {
        if (!selectEl) return;
        const allText = currentLang === "ar" ? "Ø§Ù„ÙƒÙ„" : "All";
        selectEl.innerHTML = `<option value="">${allText}</option>` + arr.map(v => `<option value="${v}">${v}</option>`).join("");
      }
      fill(refs.stageSelect, filters.stages);
      fill(refs.gradeSelect, filters.grades);
      fill(refs.subjectSelect, filters.subjects);
      fill(refs.seriesSelect, filters.series);
    }
    /* ---------- RENDER PRODUCTS (with + / - buttons) ---------- */
    function renderProducts() {
      const booksGrid = document.getElementById("booksGrid");
      const stationeryGrid = document.getElementById("stationeryGrid");
      
      if (!booksGrid || !stationeryGrid) {
        console.error("Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø¨ÙƒØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ DOM");
        return;
      }
      
      booksGrid.innerHTML = "";
      stationeryGrid.innerHTML = "";

      const search = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      const stage = document.getElementById("stageSelect").value;
      const grade = document.getElementById("gradeSelect").value;
      const subject = document.getElementById("subjectSelect").value;
      const seriesSel = document.getElementById("seriesSelect").value;

      products.forEach(p => {
        if (search && !p.name.toLowerCase().includes(search)) return;
        if (p.type === "book") {
          if ((stage && p.stage !== stage) || (grade && p.grade !== grade) || 
              (subject && p.subject !== subject) || (seriesSel && p.series !== seriesSel)) return;
        }

        const card = document.createElement("div");
        card.className = "product-card";
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
        const imgSrc = (p.images && p.images.length > 0) ? p.images[0] : "https://via.placeholder.com/300x200?text=No+Image";
        
        card.innerHTML = `
          <img class="product-image" src="${imgSrc}" alt="${p.name}">
          <div style="margin-top:8px;font-weight:800">${p.name}</div>
          <div class="product-meta" style="font-size:13px;color:#666;margin-top:6px">
            ${p.type === "book" ? `${p.stage || ""} ${p.grade ? " | " + p.grade : ""} ${p.subject ? " | " + p.subject : ""}` : (p.category || "")}
          </div>
          <div class="product-footer">
            <div style="font-weight:800">${formatCurrency(p.price)}</div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-outline btn-decrease" data-id="${p.id}">-</button>
              <button class="btn btn-primary btn-increase" data-id="${p.id}">+</button>
            </div>
          </div>
        `;

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        card.querySelector(".btn-increase").addEventListener("click", (e) => { 
          e.stopPropagation();
          addToCart(p.id); 
        });
        
        card.querySelector(".btn-decrease").addEventListener("click", (e) => { 
          e.stopPropagation();
          decreaseCartQty(p.id); 
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        card.addEventListener("click", () => {
          showProductDetails(p);
        });

        if (p.type === "book") {
          booksGrid.appendChild(card);
        } else {
          stationeryGrid.appendChild(card);
        }
      });
    }

    /* ---------- CART FUNCTIONS & CALCULATIONS ---------- */
    function addToCart(id) {
      const prod = products.find(x => x.id === id);
      if (!prod) return;
      const it = cart.find(c => c.id === id);
      if (it) it.qty += 1; else cart.push({ ...prod, qty: 1 });
      renderCart();
    }
    
    function decreaseCartQty(id) {
      const it = cart.find(c => c.id === id);
      if (!it) return;
      it.qty -= 1;
      if (it.qty <= 0) cart = cart.filter(c => c.id !== id);
      renderCart();
    }
    
    function removeFromCart(id) {
      cart = cart.filter(c => c.id !== id);
      renderCart();
    }

   function renderCart() {
  const cartItems = document.getElementById("cartItems");
  if (!cartItems) return;

  cartItems.innerHTML = "";
  let booksTotal = 0, stationeryTotal = 0;

  cart.forEach(item => {
    const row = document.createElement("div");
    row.className = "cart-item";
    row.innerHTML = `
      <div style="max-width:60%"><strong>${item.name}</strong>
        <div style="color:#666;font-size:13px">${item.qty} Ã— ${formatCurrency(item.price)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div style="font-weight:800">${formatCurrency(item.qty * item.price)}</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-outline small-dec" data-id="${item.id}">-</button>
          <button class="btn btn-outline small-inc" data-id="${item.id}">+</button>
          <button class="btn btn-outline" data-del="${item.id}"><i class="fas fa-trash"></i></button>
        </div>
      </div>
    `;
    cartItems.appendChild(row);

    row.querySelector(".small-inc").addEventListener("click", () => { addToCart(item.id); });
    row.querySelector(".small-dec").addEventListener("click", () => { decreaseCartQty(item.id); });
    row.querySelector("[data-del]").addEventListener("click", () => { removeFromCart(item.id); });

    if (item.type === "book") booksTotal += item.qty * item.price;
    else stationeryTotal += item.qty * item.price;
  });

  // --- Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
  const subtotal = booksTotal + stationeryTotal;
  const discountRate = parseFloat(discountSettings.discountRate) || 0;
  const depositRate = parseFloat(discountSettings.depositRate) || 0;

  const discountValue = subtotal > 0 ? subtotal * (discountRate / 100) : 0;
  const afterDiscount = Math.max(0, subtotal - discountValue);
  const deposit = afterDiscount * (depositRate / 100);
  const remain = Math.max(0, afterDiscount - deposit);

  // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
  document.getElementById("subtotalBooks").textContent = formatCurrency(booksTotal);
  document.getElementById("subtotalStationery").textContent = formatCurrency(stationeryTotal);
  document.getElementById("subtotalAll").textContent = formatCurrency(subtotal);
  document.getElementById("totalDiscount").textContent = formatCurrency(discountValue);
  document.getElementById("depositAmount").textContent = formatCurrency(deposit);
  document.getElementById("grandTotal").textContent = formatCurrency(afterDiscount);
  document.getElementById("remainAmount").textContent = formatCurrency(remain);

  const btnInvoice = document.getElementById("btnInvoice");
  if (btnInvoice) btnInvoice.disabled = cart.length === 0;
}


    /* ---------- TAB NAVIGATION (Books / Stationery) ---------- */
    refs.tabBooks.addEventListener("click", () => {
      refs.tabBooks.classList.add("active");
      refs.tabStationery.classList.remove("active");
      refs.booksGrid.style.display = "grid";
      refs.stationeryGrid.style.display = "none";
    });
    
    refs.tabStationery.addEventListener("click", () => {
      refs.tabStationery.classList.add("active");
      refs.tabBooks.classList.remove("active");
      refs.stationeryGrid.style.display = "grid";
      refs.booksGrid.style.display = "none";
    });

    /* ---------- SEARCH / FILTER LISTENERS ---------- */
    [refs.searchInput, refs.stageSelect, refs.gradeSelect, refs.subjectSelect, refs.seriesSelect].forEach(el => {
      if (!el) return;
      el.addEventListener("input", debounce(renderProducts, 180));
      el.addEventListener("change", renderProducts);
    });

    /* ---------- LOGIN & SETTINGS ---------- */
    refs.btnClear.addEventListener("click", () => {
      if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
      if (!confirm(T[currentLang].confirmClearCart)) return;
      cart = [];
      renderCart();
    });

    refs.btnInvoice.addEventListener("click", () => { openInvoiceModal(); });

    refs.btnInvoice.disabled = true; // initially

    document.getElementById("btnSettings").addEventListener("click", () => {
      refs.adminEmail.value = "";
      refs.adminPassword.value = "";
      refs.loginModal.classList.add("show");
    });

    refs.loginSubmit.addEventListener("click", () => {
      const e = (refs.adminEmail.value || "").trim();
      const p = (refs.adminPassword.value || "").trim();
   firebase.auth().signInWithEmailAndPassword(e, p)
  .then(userCred => {
    refs.loginModal.classList.remove("show");
    refs.settingsModal.classList.add("show");
    onSettingsOpen();
  })
  .catch(err => {
    showToast(T[currentLang].loginWrong, "error");
    console.error(err);
  });

    });

    refs.settingsTabs.forEach(btn => {
      btn.addEventListener("click", () => {
        refs.settingsTabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        refs.settingsPanels.forEach(p => p.classList.remove("active"));
        const target = btn.dataset.tab;
        const panel = document.getElementById(target);
        if (panel) panel.classList.add("active");
      });
    });

    document.querySelectorAll(".modal .close").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const modal = btn.closest(".modal");
        if (modal) modal.classList.remove("show");
      });
    });

    /* ---------- ADMIN: Products management (add / edit / delete + image upload) ---------- */

    // =============================
    // Render Admin List
    // =============================
    function renderProductsAdmin() {
      const productsList = document.getElementById("productsList");
      if (!productsList) return;
      
      productsList.innerHTML = "";

      products.forEach(p => {
        const item = document.createElement("div");
        item.style.cssText = "padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center";
        
        item.innerHTML = `
          <div>
            <strong>${p.name}</strong> - ${formatCurrency(p.price)}
            <div style="font-size:12px;color:#666">${p.type === 'book' ? 'ÙƒØªØ§Ø¨' : 'Ø£Ø¯Ø§Ø© Ù…ÙƒØªØ¨ÙŠØ©'}</div>
          </div>
          <div>
            <button class="btn btn-outline" data-edit="${p.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-danger" data-delete="${p.id}">Ø­Ø°Ù</button>
          </div>
        `;
        
        productsList.appendChild(item);

        item.querySelector(`[data-edit="${p.id}"]`).addEventListener("click", () => {
          startEditProduct(p.id);
        });
        
        item.querySelector(`[data-delete="${p.id}"]`).addEventListener("click", () => {
          if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
            products = products.filter(prod => prod.id !== p.id);
            saveAll();
            renderProductsAdmin();
            showToast(T[currentLang].productRemoved, "success");
          }
        });
      });
    }

    // =============================
    // Start Editing Product
    // =============================
    function startEditProduct(id) {
      const p = products.find(x => x.id === id); 
      if (!p) return;

      editingProductId = id;
      refs.newProdName.value = p.name || "";
      refs.newProdType.value = p.type || "book";
      refs.newProdPrice.value = p.price || 0;

      if (p.type === "book") {
        refs.newProdSeries.value = p.series || "";
      } else if (p.type === "stationery") {
        refs.newProdSeries.value = p.category || "";
      } else {
        refs.newProdSeries.value = "";
      }

      refs.newProdPreviewList.innerHTML = "";
      if (p.images && p.images.length) {
        p.images.forEach(imgSrc => {
          const img = document.createElement("img");
          img.src = imgSrc;
          img.classList.add("preview-thumb");
          refs.newProdPreviewList.appendChild(img);
        });
      }

      refs.settingsModal.classList.add("show");
    }

    // =============================
    // Preview new images immediately
    // =============================
    refs.newProdImages.addEventListener("change", (e) => {
      refs.newProdPreviewList.innerHTML = "";
      const files = e.target.files;
      for (let file of files) {
        const reader = new FileReader();
        reader.onload = () => {
          const img = document.createElement("img");
          img.src = reader.result;
          img.classList.add("preview-thumb");
          refs.newProdPreviewList.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    // =============================
    // Product Details Modal
    // =============================
    function showProductDetails(product) {
      const container = document.getElementById("productDetails");
      container.innerHTML = `
        <h2>${product.name}</h2>
        <div class="product-details-images">
          ${(product.images || []).map(img => `<img src="${img}">`).join("")}
        </div>
        <div class="product-info">
          <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${formatCurrency(product.price)}</p>
          ${product.type === "book" ? `
            <p><strong>Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</strong> ${product.stage || ""}</p>
            <p><strong>Ø§Ù„ØµÙ:</strong> ${product.grade || ""}</p>
            <p><strong>Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${product.subject || ""}</p>
            <p><strong>Ø§Ù„Ø³Ù„Ø³Ù„Ø©:</strong> ${product.series || ""}</p>
          ` : `
            <p><strong>Ø§Ù„ØªØµÙ†ÙŠÙ:</strong> ${product.category || ""}</p>
          `}
        </div>
      `;
      document.getElementById("productModal").classList.add("show");
    }

    document.getElementById("closeProductModal").addEventListener("click", () => {
      document.getElementById("productModal").classList.remove("show");
    });

    // =============================
    // Add Product
    // =============================
    refs.addProductBtn.addEventListener("click", async () => {
      const name = (refs.newProdName.value || "").trim();
      const type = refs.newProdType.value;
      const price = parseFloat(refs.newProdPrice.value) || 0;
      const seriesOrCat = (refs.newProdSeries.value || "").trim();

      if (!name) { showToast(T[currentLang].enterProdName, "error"); return; }

      let imagesData = [];
      if (refs.newProdImages.files.length > 0) {
        imagesData = await Promise.all(Array.from(refs.newProdImages.files).map(file => fileToBase64(file)));
      }

      const id = Date.now().toString();
      const item = type === "book"
        ? { id, type: "book", name, price, stage: filters.stages[0] || "", grade: filters.grades[0] || "", subject: filters.subjects[0] || "", series: seriesOrCat, images: imagesData }
        : { id, type: "stationery", name, price, category: seriesOrCat, images: imagesData };

      products.push(item);
      saveAll();
      renderProducts();      
      renderProductsAdmin();

      refs.newProdName.value = "";
      refs.newProdPrice.value = "";
      refs.newProdSeries.value = "";
      refs.newProdImages.value = "";
      refs.newProdPreviewList.innerHTML = "";
      showToast(T[currentLang].productAdded, "success");
    });

    // =============================
    // Update Product
    // =============================
    refs.updateProductBtn.addEventListener("click", async () => {
      if (!editingProductId) { showToast(T[currentLang].noEdit, "error"); return; }
      const p = products.find(x => x.id === editingProductId); 
      if (!p) return;

      p.name = (refs.newProdName.value || "").trim();
      p.type = refs.newProdType.value;
      p.price = parseFloat(refs.newProdPrice.value) || 0;

      if (p.type === "book") {
        p.series = (refs.newProdSeries.value || "").trim();
      } else if (p.type === "stationery") {
        p.category = (refs.newProdSeries.value || "").trim();
      }

      if (refs.newProdImages.files.length > 0) {
        p.images = await Promise.all(Array.from(refs.newProdImages.files).map(file => fileToBase64(file)));
      }

      saveAll();
      renderProducts(); 
      renderProductsAdmin();

      editingProductId = null;
      refs.newProdName.value = "";
      refs.newProdPrice.value = "";
      refs.newProdSeries.value = "";
      refs.newProdImages.value = "";
      refs.newProdPreviewList.innerHTML = "";
      showToast(T[currentLang].productUpdated, "success");
    });

    /* ---------- ADMIN: Filters management (add / delete) ---------- */
    function renderFiltersAdmin() {
      function renderList(containerEl, arr, type) {
        containerEl.innerHTML = "";
        arr.forEach((item, i) => {
          const div = document.createElement("div");
          div.style = "display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px";
          div.innerHTML = `<span>${item}</span><button class="btn btn-outline" data-del="${type}-${i}"><i class="fas fa-trash"></i></button>`;
          containerEl.appendChild(div);
          div.querySelector("[data-del]").addEventListener("click", () => {
            filters[type].splice(i, 1);
            saveAll();
            renderFiltersAdmin();
            populateFilterSelects();
            showToast(T[currentLang].filtersSaved, "success");
          });
        });
      }
      renderList(refs.filtersStages, filters.stages, "stages");
      renderList(refs.filtersGrades, filters.grades, "grades");
      renderList(refs.filtersSubjects, filters.subjects, "subjects");
      renderList(refs.filtersSeries, filters.series, "series");
    }

    refs.addStageBtn.addEventListener("click", () => {
      const val = (refs.newStage.value || "").trim();
      if (!val) return;
      if (!filters.stages.includes(val)) filters.stages.push(val);
      refs.newStage.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addGradeBtn.addEventListener("click", () => {
      const val = (refs.newGrade.value || "").trim();
      if (!val) return;
      if (!filters.grades.includes(val)) filters.grades.push(val);
      refs.newGrade.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addSubjectBtn.addEventListener("click", () => {
      const val = (refs.newSubject.value || "").trim();
      if (!val) return;
      if (!filters.subjects.includes(val)) filters.subjects.push(val);
      refs.newSubject.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });
    
    refs.addSeriesBtn.addEventListener("click", () => {
      const val = (refs.newSeries.value || "").trim();
      if (!val) return;
      if (!filters.series.includes(val)) filters.series.push(val);
      refs.newSeries.value = "";
      saveAll(); 
      renderFiltersAdmin(); 
      populateFilterSelects();
      showToast(T[currentLang].filtersSaved, "success");
    });

    /* ---------- ADMIN: Discount save ---------- */
    refs.saveDiscountBtn.addEventListener("click", () => {
      discountSettings.discountRate = parseFloat(refs.discountRate.value) || 0;
      discountSettings.depositRate = parseFloat(refs.depositRate.value) || 0;
      saveAll();
      renderCart();
      showToast(T[currentLang].saveDiscount, "success");
    });

    /* ---------- INVOICE / PDF ---------- */
    function openInvoiceModal() {
      if (cart.length === 0) { showToast(T[currentLang].cartEmpty, "info"); return; }
      let html = `<p><strong>${T[currentLang].invoiceTitle}</strong></p>`;
      html += `<p><strong>${T[currentLang].parentName || "Client"}:</strong> ${refs.custName.value || "-" }<br>`;
      html += `<strong>${T[currentLang].phone || "Phone"}:</strong> ${refs.custPhone.value || "-" }<br>`;
      html += `<strong>${T[currentLang].address || "Address"}:</strong> ${refs.custAddress.value || "-" }</p>`;
      html += `<table style="width:100%;border-collapse:collapse"><thead><tr style="background:#f0f0f0"><th style="padding:6px;border:1px solid #eee">Ø§Ù„Ù…Ù†ØªØ¬</th><th style="padding:6px;border:1px solid #eee">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th style="padding:6px;border:1px solid #eee">Ø§Ù„Ø³Ø¹Ø±</th><th style="padding:6px;border:1px solid #eee">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead><tbody>`;
      cart.forEach(i => {
        html += `<tr><td style="padding:6px;border:1px solid #eee">${i.name}</td><td style="padding:6px;border:1px solid #eee">${i.qty}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.price)}</td><td style="padding:6px;border:1px solid #eee">${formatCurrency(i.qty * i.price)}</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<p><strong>${T[currentLang].subtotalAll}</strong> ${refs.subtotalAll.textContent}<br>`;
      html += `<strong>${T[currentLang].totalDiscount}</strong> ${refs.totalDiscount.textContent}<br>`;
      html += `<strong>${T[currentLang].grandTotal}</strong> ${refs.grandTotal.textContent}<br>`;
      html += `<strong>${T[currentLang].depositAmount}</strong> ${refs.depositAmount.textContent}<br>`;
      html += `<strong>${T[currentLang].remainAmount}</strong> ${refs.remainAmount.textContent}</p>`;

      refs.invoiceBody.innerHTML = html;
      refs.invoiceModal.classList.add("show");
    }
    
    refs.printInvoiceBtn.addEventListener("click", () => window.print());
    
    refs.downloadPdfBtn.addEventListener("click", () => {
  const pdf = new jspdf.jsPDF("p", "pt", "a4");
  pdf.html(refs.invoiceBody, {
    callback: function (pdf) {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      if (isMobile) {
        // Ø§ÙØªØ­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
        const pdfUrl = pdf.output("bloburl");
        window.open(pdfUrl, "_blank");
      } else {
        // ØªÙ†Ø²ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
        const pdfBlob = pdf.output("blob");
        const link = document.createElement("a");
        link.href = URL.createObjectURL(pdfBlob);
        link.download = "invoice.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
      }
    }
  });
});

    /* ---------- SETTINGS OPEN initial sync ---------- */
    function onSettingsOpen() {
      renderProductsAdmin();
      refs.discountRate.value = discountSettings.discountRate;
      refs.depositRate.value = discountSettings.depositRate;
      renderFiltersAdmin();
    }

    /* ---------- INITIALIZATION ---------- */
    async function init() {
      applyTranslations();
      populateFilterSelects();
      
      try {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
        await loadDataFromFirebase();
        console.log("ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase");
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        loadFromLocalStorage();
        console.log("ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ");
        showToast("ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ ØºÙŠØ± Ø§Ù„Ù…ØªØµÙ„", "info");
      }
      
      renderProducts();
      renderCart();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      document.querySelectorAll(".modal .close").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const modal = btn.closest(".modal");
          if (modal) modal.classList.remove("show");
        });
      });
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
      const searchInput = document.getElementById("searchInput");
      const stageSelect = document.getElementById("stageSelect");
      const gradeSelect = document.getElementById("gradeSelect");
      const subjectSelect = document.getElementById("subjectSelect");
      const seriesSelect = document.getElementById("seriesSelect");
      
      if (searchInput) searchInput.addEventListener("input", debounce(renderProducts, 300));
      if (stageSelect) stageSelect.addEventListener("change", renderProducts);
      if (gradeSelect) gradeSelect.addEventListener("change", renderProducts);
      if (subjectSelect) subjectSelect.addEventListener("change", renderProducts);
      if (seriesSelect) seriesSelect.addEventListener("change", renderProducts);
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ÙƒØªØ¨ÙŠØ©
      const tabBooks = document.getElementById("tabBooks");
      const tabStationery = document.getElementById("tabStationery");
      
      if (tabBooks && tabStationery) {
        tabBooks.addEventListener("click", () => {
          tabBooks.classList.add("active");
          tabStationery.classList.remove("active");
          document.getElementById("booksGrid").style.display = "grid";
          document.getElementById("stationeryGrid").style.display = "none";
        });
        
        tabStationery.addEventListener("click", () => {
          tabStationery.classList.add("active");
          tabBooks.classList.remove("active");
          document.getElementById("stationeryGrid").style.display = "grid";
          document.getElementById("booksGrid").style.display = "none";
        });
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    init();

    /* ---------- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª ---------- */
  </script>
</body>
</html>
